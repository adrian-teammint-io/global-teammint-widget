import{F as Es,aK as Ra,aL as I,V as $a,U as Pa,y as $e,L as Jn,i as Xe,ad as Ea,ap as Ma,M as Na,I as Ms,J as Ns,B as Se,f as js,aM as ja,E as mn,aN as Kn,aO as Ua,aP as La,aQ as Da,K as Zn,aR as zn,aS as Fa,t as Ba,D as Gt}from"./index-Dnlk3cN0.js";import{c as Wa,j as qa,h as Ja,f as Us,S as Hn,J as Vn,R as Xn}from"./index-JNCLaBht.js";import{k as Ka,m as Za,o as K,l as ee,i as Ls,n as J,d as At,s as Q,h as gn,q as za}from"./index-CTPvdefa.js";import{J as Gn,c as Ha,p as Ds,m as at}from"./llms-BLW_VGg4.js";import"./embeddings-B8aKgKJK.js";import"./index-DGjFeGIT.js";import"./index-DRz5BQNA.js";function Ge(t,e){return t.lc_error_code=e,t.message=`${t.message}

Troubleshooting URL: https://docs.langchain.com/oss/javascript/langchain/errors/${e}/
`,t}function O(t,e,n,s,r){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,n),n}function c(t,e,n,s){if(n==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?t!==e||!s:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?s:n==="a"?s.call(t):s?s.value:e.get(t)}let Fs=function(){const{crypto:t}=globalThis;if(t?.randomUUID)return Fs=t.randomUUID.bind(t),t.randomUUID();const e=new Uint8Array(1),n=t?()=>t.getRandomValues(e)[0]:()=>Math.random()*255&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,s=>(+s^n()&15>>+s/4).toString(16))};function Qt(t){return typeof t=="object"&&t!==null&&("name"in t&&t.name==="AbortError"||"message"in t&&String(t.message).includes("FetchRequestCanceledException"))}const Yt=t=>{if(t instanceof Error)return t;if(typeof t=="object"&&t!==null){try{if(Object.prototype.toString.call(t)==="[object Error]"){const e=new Error(t.message,t.cause?{cause:t.cause}:{});return t.stack&&(e.stack=t.stack),t.cause&&!e.cause&&(e.cause=t.cause),t.name&&(e.name=t.name),e}}catch{}try{return new Error(JSON.stringify(t))}catch{}}return new Error(t)};class x extends Error{}class q extends x{constructor(e,n,s,r){super(`${q.makeMessage(e,n,s)}`),this.status=e,this.headers=r,this.requestID=r?.get("x-request-id"),this.error=n;const a=n;this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,n,s){const r=n?.message?typeof n.message=="string"?n.message:JSON.stringify(n.message):n?JSON.stringify(n):s;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,n,s,r){if(!e||!r)return new Rt({message:s,cause:Yt(n)});const a=n?.error;return e===400?new Bs(e,a,s,r):e===401?new Ws(e,a,s,r):e===403?new qs(e,a,s,r):e===404?new Js(e,a,s,r):e===409?new Ks(e,a,s,r):e===422?new Zs(e,a,s,r):e===429?new zs(e,a,s,r):e>=500?new Hs(e,a,s,r):new q(e,a,s,r)}}class Y extends q{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Rt extends q{constructor({message:e,cause:n}){super(void 0,void 0,e||"Connection error.",void 0),n&&(this.cause=n)}}class $t extends Rt{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Bs extends q{}class Ws extends q{}class qs extends q{}class Js extends q{}class Ks extends q{}class Zs extends q{}class zs extends q{}class Hs extends q{}class Vs extends x{constructor(){super("Could not parse response content as the length limit was reached")}}class Xs extends x{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class Pe extends Error{constructor(e){super(e)}}const Va=/^[a-z][a-z0-9+.-]*:/i,Xa=t=>Va.test(t);let H=t=>(H=Array.isArray,H(t)),Qn=H;function Gs(t){return typeof t!="object"?{}:t??{}}function Ga(t){if(!t)return!0;for(const e in t)return!1;return!0}function Qa(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function Wt(t){return t!=null&&typeof t=="object"&&!Array.isArray(t)}const Ya=(t,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new x(`${t} must be an integer`);if(e<0)throw new x(`${t} must be a positive integer`);return e},ei=t=>{try{return JSON.parse(t)}catch{return}},Ke=t=>new Promise(e=>setTimeout(e,t)),Oe="6.10.0",ti=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";function ni(){return typeof Deno<"u"&&Deno.build!=null?"deno":typeof EdgeRuntime<"u"?"edge":Object.prototype.toString.call(typeof globalThis.process<"u"?globalThis.process:0)==="[object process]"?"node":"unknown"}const si=()=>{const t=ni();if(t==="deno")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Oe,"X-Stainless-OS":es(Deno.build.os),"X-Stainless-Arch":Yn(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Oe,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if(t==="node")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Oe,"X-Stainless-OS":es(globalThis.process.platform??"unknown"),"X-Stainless-Arch":Yn(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const e=ri();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Oe,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Oe,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function ri(){if(typeof navigator>"u"||!navigator)return null;const t=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:n}of t){const s=n.exec(navigator.userAgent);if(s){const r=s[1]||0,a=s[2]||0,i=s[3]||0;return{browser:e,version:`${r}.${a}.${i}`}}}return null}const Yn=t=>t==="x32"?"x32":t==="x86_64"||t==="x64"?"x64":t==="arm"?"arm":t==="aarch64"||t==="arm64"?"arm64":t?`other:${t}`:"unknown",es=t=>(t=t.toLowerCase(),t.includes("ios")?"iOS":t==="android"?"Android":t==="darwin"?"MacOS":t==="win32"?"Windows":t==="freebsd"?"FreeBSD":t==="openbsd"?"OpenBSD":t==="linux"?"Linux":t?`Other:${t}`:"Unknown");let ts;const ai=()=>ts??(ts=si());function ii(){if(typeof fetch<"u")return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}function Qs(...t){const e=globalThis.ReadableStream;if(typeof e>"u")throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new e(...t)}function Ys(t){let e=Symbol.asyncIterator in t?t[Symbol.asyncIterator]():t[Symbol.iterator]();return Qs({start(){},async pull(n){const{done:s,value:r}=await e.next();s?n.close():n.enqueue(r)},async cancel(){await e.return?.()}})}function er(t){if(t[Symbol.asyncIterator])return t;const e=t.getReader();return{async next(){try{const n=await e.read();return n?.done&&e.releaseLock(),n}catch(n){throw e.releaseLock(),n}},async return(){const n=e.cancel();return e.releaseLock(),await n,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function oi(t){if(t===null||typeof t!="object")return;if(t[Symbol.asyncIterator]){await t[Symbol.asyncIterator]().return?.();return}const e=t.getReader(),n=e.cancel();e.releaseLock(),await n}const ui=({headers:t,body:e})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(e)}),tr="RFC3986",nr=t=>String(t),ns={RFC1738:t=>String(t).replace(/%20/g,"+"),RFC3986:nr},li="RFC1738";let en=(t,e)=>(en=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),en(t,e));const re=(()=>{const t=[];for(let e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t})(),qt=1024,ci=(t,e,n,s,r)=>{if(t.length===0)return t;let a=t;if(typeof t=="symbol"?a=Symbol.prototype.toString.call(t):typeof t!="string"&&(a=String(t)),n==="iso-8859-1")return escape(a).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let i="";for(let o=0;o<a.length;o+=qt){const l=a.length>=qt?a.slice(o,o+qt):a,u=[];for(let m=0;m<l.length;++m){let p=l.charCodeAt(m);if(p===45||p===46||p===95||p===126||p>=48&&p<=57||p>=65&&p<=90||p>=97&&p<=122||r===li&&(p===40||p===41)){u[u.length]=l.charAt(m);continue}if(p<128){u[u.length]=re[p];continue}if(p<2048){u[u.length]=re[192|p>>6]+re[128|p&63];continue}if(p<55296||p>=57344){u[u.length]=re[224|p>>12]+re[128|p>>6&63]+re[128|p&63];continue}m+=1,p=65536+((p&1023)<<10|l.charCodeAt(m)&1023),u[u.length]=re[240|p>>18]+re[128|p>>12&63]+re[128|p>>6&63]+re[128|p&63]}i+=u.join("")}return i};function di(t){return!t||typeof t!="object"?!1:!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))}function ss(t,e){if(H(t)){const n=[];for(let s=0;s<t.length;s+=1)n.push(e(t[s]));return n}return e(t)}const sr={brackets(t){return String(t)+"[]"},comma:"comma",indices(t,e){return String(t)+"["+e+"]"},repeat(t){return String(t)}},rr=function(t,e){Array.prototype.push.apply(t,H(e)?e:[e])};let rs;const j={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:ci,encodeValuesOnly:!1,format:tr,formatter:nr,indices:!1,serializeDate(t){return(rs??(rs=Function.prototype.call.bind(Date.prototype.toISOString)))(t)},skipNulls:!1,strictNullHandling:!1};function pi(t){return typeof t=="string"||typeof t=="number"||typeof t=="boolean"||typeof t=="symbol"||typeof t=="bigint"}const Jt={};function ar(t,e,n,s,r,a,i,o,l,u,m,p,f,d,b,w,$,h){let g=t,T=h,C=0,Z=!1;for(;(T=T.get(Jt))!==void 0&&!Z;){const P=T.get(t);if(C+=1,typeof P<"u"){if(P===C)throw new RangeError("Cyclic object value");Z=!0}typeof T.get(Jt)>"u"&&(C=0)}if(typeof u=="function"?g=u(e,g):g instanceof Date?g=f?.(g):n==="comma"&&H(g)&&(g=ss(g,function(P){return P instanceof Date?f?.(P):P})),g===null){if(a)return l&&!w?l(e,j.encoder,$,"key",d):e;g=""}if(pi(g)||di(g)){if(l){const P=w?e:l(e,j.encoder,$,"key",d);return[b?.(P)+"="+b?.(l(g,j.encoder,$,"value",d))]}return[b?.(e)+"="+b?.(String(g))]}const U=[];if(typeof g>"u")return U;let R;if(n==="comma"&&H(g))w&&l&&(g=ss(g,l)),R=[{value:g.length>0?g.join(",")||null:void 0}];else if(H(u))R=u;else{const P=Object.keys(g);R=m?P.sort(m):P}const F=o?String(e).replace(/\./g,"%2E"):String(e),L=s&&H(g)&&g.length===1?F+"[]":F;if(r&&H(g)&&g.length===0)return L+"[]";for(let P=0;P<R.length;++P){const M=R[P],Wn=typeof M=="object"&&typeof M.value<"u"?M.value:g[M];if(i&&Wn===null)continue;const Bt=p&&o?M.replace(/\./g,"%2E"):M,Aa=H(g)?typeof n=="function"?n(L,Bt):L:L+(p?"."+Bt:"["+Bt+"]");h.set(t,C);const qn=new WeakMap;qn.set(Jt,h),rr(U,ar(Wn,Aa,n,s,r,a,i,o,n==="comma"&&w&&H(g)?null:l,u,m,p,f,d,b,w,$,qn))}return U}function fi(t=j){if(typeof t.allowEmptyArrays<"u"&&typeof t.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof t.encodeDotInKeys<"u"&&typeof t.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(t.encoder!==null&&typeof t.encoder<"u"&&typeof t.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=t.charset||j.charset;if(typeof t.charset<"u"&&t.charset!=="utf-8"&&t.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=tr;if(typeof t.format<"u"){if(!en(ns,t.format))throw new TypeError("Unknown format option provided.");n=t.format}const s=ns[n];let r=j.filter;(typeof t.filter=="function"||H(t.filter))&&(r=t.filter);let a;if(t.arrayFormat&&t.arrayFormat in sr?a=t.arrayFormat:"indices"in t?a=t.indices?"indices":"repeat":a=j.arrayFormat,"commaRoundTrip"in t&&typeof t.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=typeof t.allowDots>"u"?t.encodeDotInKeys?!0:j.allowDots:!!t.allowDots;return{addQueryPrefix:typeof t.addQueryPrefix=="boolean"?t.addQueryPrefix:j.addQueryPrefix,allowDots:i,allowEmptyArrays:typeof t.allowEmptyArrays=="boolean"?!!t.allowEmptyArrays:j.allowEmptyArrays,arrayFormat:a,charset:e,charsetSentinel:typeof t.charsetSentinel=="boolean"?t.charsetSentinel:j.charsetSentinel,commaRoundTrip:!!t.commaRoundTrip,delimiter:typeof t.delimiter>"u"?j.delimiter:t.delimiter,encode:typeof t.encode=="boolean"?t.encode:j.encode,encodeDotInKeys:typeof t.encodeDotInKeys=="boolean"?t.encodeDotInKeys:j.encodeDotInKeys,encoder:typeof t.encoder=="function"?t.encoder:j.encoder,encodeValuesOnly:typeof t.encodeValuesOnly=="boolean"?t.encodeValuesOnly:j.encodeValuesOnly,filter:r,format:n,formatter:s,serializeDate:typeof t.serializeDate=="function"?t.serializeDate:j.serializeDate,skipNulls:typeof t.skipNulls=="boolean"?t.skipNulls:j.skipNulls,sort:typeof t.sort=="function"?t.sort:null,strictNullHandling:typeof t.strictNullHandling=="boolean"?t.strictNullHandling:j.strictNullHandling}}function hi(t,e={}){let n=t;const s=fi(e);let r,a;typeof s.filter=="function"?(a=s.filter,n=a("",n)):H(s.filter)&&(a=s.filter,r=a);const i=[];if(typeof n!="object"||n===null)return"";const o=sr[s.arrayFormat],l=o==="comma"&&s.commaRoundTrip;r||(r=Object.keys(n)),s.sort&&r.sort(s.sort);const u=new WeakMap;for(let f=0;f<r.length;++f){const d=r[f];s.skipNulls&&n[d]===null||rr(i,ar(n[d],d,o,l,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,u))}const m=i.join(s.delimiter);let p=s.addQueryPrefix===!0?"?":"";return s.charsetSentinel&&(s.charset==="iso-8859-1"?p+="utf8=%26%2310003%3B&":p+="utf8=%E2%9C%93&"),m.length>0?p+m:""}function mi(t){let e=0;for(const r of t)e+=r.length;const n=new Uint8Array(e);let s=0;for(const r of t)n.set(r,s),s+=r.length;return n}let as;function _n(t){let e;return(as??(e=new globalThis.TextEncoder,as=e.encode.bind(e)))(t)}let is;function os(t){let e;return(is??(e=new globalThis.TextDecoder,is=e.decode.bind(e)))(t)}var V,X;class Pt{constructor(){V.set(this,void 0),X.set(this,void 0),O(this,V,new Uint8Array),O(this,X,null)}decode(e){if(e==null)return[];const n=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?_n(e):e;O(this,V,mi([c(this,V,"f"),n]));const s=[];let r;for(;(r=gi(c(this,V,"f"),c(this,X,"f")))!=null;){if(r.carriage&&c(this,X,"f")==null){O(this,X,r.index);continue}if(c(this,X,"f")!=null&&(r.index!==c(this,X,"f")+1||r.carriage)){s.push(os(c(this,V,"f").subarray(0,c(this,X,"f")-1))),O(this,V,c(this,V,"f").subarray(c(this,X,"f"))),O(this,X,null);continue}const a=c(this,X,"f")!==null?r.preceding-1:r.preceding,i=os(c(this,V,"f").subarray(0,a));s.push(i),O(this,V,c(this,V,"f").subarray(r.index)),O(this,X,null)}return s}flush(){return c(this,V,"f").length?this.decode(`
`):[]}}V=new WeakMap,X=new WeakMap;Pt.NEWLINE_CHARS=new Set([`
`,"\r"]);Pt.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function gi(t,e){for(let r=e??0;r<t.length;r++){if(t[r]===10)return{preceding:r,index:r+1,carriage:!1};if(t[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function _i(t){for(let s=0;s<t.length-1;s++){if(t[s]===10&&t[s+1]===10||t[s]===13&&t[s+1]===13)return s+2;if(t[s]===13&&t[s+1]===10&&s+3<t.length&&t[s+2]===13&&t[s+3]===10)return s+4}return-1}const mt={off:0,error:200,warn:300,info:400,debug:500},us=(t,e,n)=>{if(t){if(Qa(mt,t))return t;B(n).warn(`${e} was set to ${JSON.stringify(t)}, expected one of ${JSON.stringify(Object.keys(mt))}`)}};function Ee(){}function Qe(t,e,n){return!e||mt[t]>mt[n]?Ee:e[t].bind(e)}const yi={error:Ee,warn:Ee,info:Ee,debug:Ee};let ls=new WeakMap;function B(t){const e=t.logger,n=t.logLevel??"off";if(!e)return yi;const s=ls.get(e);if(s&&s[0]===n)return s[1];const r={error:Qe("error",e,n),warn:Qe("warn",e,n),info:Qe("info",e,n),debug:Qe("debug",e,n)};return ls.set(e,[n,r]),r}const fe=t=>(t.options&&(t.options={...t.options},delete t.options.headers),t.headers&&(t.headers=Object.fromEntries((t.headers instanceof Headers?[...t.headers]:Object.entries(t.headers)).map(([e,n])=>[e,e.toLowerCase()==="authorization"||e.toLowerCase()==="cookie"||e.toLowerCase()==="set-cookie"?"***":n]))),"retryOfRequestLogID"in t&&(t.retryOfRequestLogID&&(t.retryOf=t.retryOfRequestLogID),delete t.retryOfRequestLogID),t);var Re;class ie{constructor(e,n,s){this.iterator=e,Re.set(this,void 0),this.controller=n,O(this,Re,s)}static fromSSEResponse(e,n,s){let r=!1;const a=s?B(s):console;async function*i(){if(r)throw new x("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const l of wi(e,n))if(!o){if(l.data.startsWith("[DONE]")){o=!0;continue}if(l.event===null||!l.event.startsWith("thread.")){let u;try{u=JSON.parse(l.data)}catch(m){throw a.error("Could not parse message into JSON:",l.data),a.error("From chunk:",l.raw),m}if(u&&u.error)throw new q(void 0,u.error,void 0,e.headers);yield u}else{let u;try{u=JSON.parse(l.data)}catch(m){throw console.error("Could not parse message into JSON:",l.data),console.error("From chunk:",l.raw),m}if(l.event=="error")throw new q(void 0,u.error,u.message,void 0);yield{event:l.event,data:u}}}o=!0}catch(l){if(Qt(l))return;throw l}finally{o||n.abort()}}return new ie(i,n,s)}static fromReadableStream(e,n,s){let r=!1;async function*a(){const o=new Pt,l=er(e);for await(const u of l)for(const m of o.decode(u))yield m;for(const u of o.flush())yield u}async function*i(){if(r)throw new x("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const l of a())o||l&&(yield JSON.parse(l));o=!0}catch(l){if(Qt(l))return;throw l}finally{o||n.abort()}}return new ie(i,n,s)}[(Re=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],n=[],s=this.iterator(),r=a=>({next:()=>{if(a.length===0){const i=s.next();e.push(i),n.push(i)}return a.shift()}});return[new ie(()=>r(e),this.controller,c(this,Re,"f")),new ie(()=>r(n),this.controller,c(this,Re,"f"))]}toReadableStream(){const e=this;let n;return Qs({async start(){n=e[Symbol.asyncIterator]()},async pull(s){try{const{value:r,done:a}=await n.next();if(a)return s.close();const i=_n(JSON.stringify(r)+`
`);s.enqueue(i)}catch(r){s.error(r)}},async cancel(){await n.return?.()}})}}async function*wi(t,e){if(!t.body)throw e.abort(),typeof globalThis.navigator<"u"&&globalThis.navigator.product==="ReactNative"?new x("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api"):new x("Attempted to iterate over a response with no body");const n=new vi,s=new Pt,r=er(t.body);for await(const a of bi(r))for(const i of s.decode(a)){const o=n.decode(i);o&&(yield o)}for(const a of s.flush()){const i=n.decode(a);i&&(yield i)}}async function*bi(t){let e=new Uint8Array;for await(const n of t){if(n==null)continue;const s=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?_n(n):n;let r=new Uint8Array(e.length+s.length);r.set(e),r.set(s,e.length),e=r;let a;for(;(a=_i(e))!==-1;)yield e.slice(0,a),e=e.slice(a)}e.length>0&&(yield e)}class vi{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,s,r]=xi(e,":");return r.startsWith(" ")&&(r=r.substring(1)),n==="event"?this.event=r:n==="data"&&this.data.push(r),null}}function xi(t,e){const n=t.indexOf(e);return n!==-1?[t.substring(0,n),e,t.substring(n+e.length)]:[t,"",""]}async function ir(t,e){const{response:n,requestLogID:s,retryOfRequestLogID:r,startTime:a}=e,i=await(async()=>{if(e.options.stream)return B(t).debug("response",n.status,n.url,n.headers,n.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(n,e.controller,t):ie.fromSSEResponse(n,e.controller,t);if(n.status===204)return null;if(e.options.__binaryResponse)return n;const l=n.headers.get("content-type")?.split(";")[0]?.trim();if(l?.includes("application/json")||l?.endsWith("+json")){const p=await n.json();return or(p,n)}return await n.text()})();return B(t).debug(`[${s}] response parsed`,fe({retryOfRequestLogID:r,url:n.url,status:n.status,body:i,durationMs:Date.now()-a})),i}function or(t,e){return!t||typeof t!="object"||Array.isArray(t)?t:Object.defineProperty(t,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}var Me;class Et extends Promise{constructor(e,n,s=ir){super(r=>{r(null)}),this.responsePromise=n,this.parseResponse=s,Me.set(this,void 0),O(this,Me,e)}_thenUnwrap(e){return new Et(c(this,Me,"f"),this.responsePromise,async(n,s)=>or(e(await this.parseResponse(n,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,n]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:n,request_id:n.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(c(this,Me,"f"),e))),this.parsedPromise}then(e,n){return this.parse().then(e,n)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}Me=new WeakMap;var Ye;class yn{constructor(e,n,s,r){Ye.set(this,void 0),O(this,Ye,e),this.options=r,this.response=n,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageRequestOptions()!=null:!1}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new x("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await c(this,Ye,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ye=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const n of e.getPaginatedItems())yield n}}class Oi extends Et{constructor(e,n,s){super(e,n,async(r,a)=>new s(r,a.response,await ir(r,a),a.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const n of e)yield n}}class Mt extends yn{constructor(e,n,s,r){super(e,n,s,r),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class E extends yn{constructor(e,n,s,r){super(e,n,s,r),this.data=s.data||[],this.has_more=s.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const e=this.getPaginatedItems(),n=e[e.length-1]?.id;return n?{...this.options,query:{...Gs(this.options.query),after:n}}:null}}class gt extends yn{constructor(e,n,s,r){super(e,n,s,r),this.data=s.data||[],this.has_more=s.has_more||!1,this.last_id=s.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...Gs(this.options.query),after:e}}:null}}const ur=()=>{if(typeof File>"u"){const{process:t}=globalThis,e=typeof t?.versions?.node=="string"&&parseInt(t.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(e?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function Be(t,e,n){return ur(),new File(t,e??"unknown_file",n)}function it(t){return(typeof t=="object"&&t!==null&&("name"in t&&t.name&&String(t.name)||"url"in t&&t.url&&String(t.url)||"filename"in t&&t.filename&&String(t.filename)||"path"in t&&t.path&&String(t.path))||"").split(/[\\/]/).pop()||void 0}const wn=t=>t!=null&&typeof t=="object"&&typeof t[Symbol.asyncIterator]=="function",cs=async(t,e)=>tn(t.body)?{...t,body:await lr(t.body,e)}:t,we=async(t,e)=>({...t,body:await lr(t.body,e)}),ds=new WeakMap;function Ii(t){const e=typeof t=="function"?t:t.fetch,n=ds.get(e);if(n)return n;const s=(async()=>{try{const r="Response"in e?e.Response:(await e("data:,")).constructor,a=new FormData;return a.toString()!==await new r(a).text()}catch{return!0}})();return ds.set(e,s),s}const lr=async(t,e)=>{if(!await Ii(e))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const n=new FormData;return await Promise.all(Object.entries(t||{}).map(([s,r])=>nn(n,s,r))),n},cr=t=>t instanceof Blob&&"name"in t,ki=t=>typeof t=="object"&&t!==null&&(t instanceof Response||wn(t)||cr(t)),tn=t=>{if(ki(t))return!0;if(Array.isArray(t))return t.some(tn);if(t&&typeof t=="object"){for(const e in t)if(tn(t[e]))return!0}return!1},nn=async(t,e,n)=>{if(n!==void 0){if(n==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")t.append(e,String(n));else if(n instanceof Response)t.append(e,Be([await n.blob()],it(n)));else if(wn(n))t.append(e,Be([await new Response(Ys(n)).blob()],it(n)));else if(cr(n))t.append(e,n,it(n));else if(Array.isArray(n))await Promise.all(n.map(s=>nn(t,e+"[]",s)));else if(typeof n=="object")await Promise.all(Object.entries(n).map(([s,r])=>nn(t,`${e}[${s}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`)}},dr=t=>t!=null&&typeof t=="object"&&typeof t.size=="number"&&typeof t.type=="string"&&typeof t.text=="function"&&typeof t.slice=="function"&&typeof t.arrayBuffer=="function",Ti=t=>t!=null&&typeof t=="object"&&typeof t.name=="string"&&typeof t.lastModified=="number"&&dr(t),Si=t=>t!=null&&typeof t=="object"&&typeof t.url=="string"&&typeof t.blob=="function";async function Ci(t,e,n){if(ur(),t=await t,Ti(t))return t instanceof File?t:Be([await t.arrayBuffer()],t.name);if(Si(t)){const r=await t.blob();return e||(e=new URL(t.url).pathname.split(/[\\/]/).pop()),Be(await sn(r),e,n)}const s=await sn(t);if(e||(e=it(t)),!n?.type){const r=s.find(a=>typeof a=="object"&&"type"in a&&a.type);typeof r=="string"&&(n={...n,type:r})}return Be(s,e,n)}async function sn(t){let e=[];if(typeof t=="string"||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)e.push(t);else if(dr(t))e.push(t instanceof Blob?t:await t.arrayBuffer());else if(wn(t))for await(const n of t)e.push(...await sn(n));else{const n=t?.constructor?.name;throw new Error(`Unexpected data type: ${typeof t}${n?`; constructor: ${n}`:""}${Ai(t)}`)}return e}function Ai(t){return typeof t!="object"||t===null?"":`; props: [${Object.getOwnPropertyNames(t).map(n=>`"${n}"`).join(", ")}]`}class v{constructor(e){this._client=e}}function pr(t){return t.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const ps=Object.freeze(Object.create(null)),Ri=(t=pr)=>function(n,...s){if(n.length===1)return n[0];let r=!1;const a=[],i=n.reduce((m,p,f)=>{/[?#]/.test(p)&&(r=!0);const d=s[f];let b=(r?encodeURIComponent:t)(""+d);return f!==s.length&&(d==null||typeof d=="object"&&d.toString===Object.getPrototypeOf(Object.getPrototypeOf(d.hasOwnProperty??ps)??ps)?.toString)&&(b=d+"",a.push({start:m.length+p.length,length:b.length,error:`Value of type ${Object.prototype.toString.call(d).slice(8,-1)} is not a valid path parameter`})),m+p+(f===s.length?"":b)},""),o=i.split(/[?#]/,1)[0],l=new RegExp("(?<=^|\\/)(?:\\.|%2e){1,2}(?=\\/|$)","gi");let u;for(;(u=l.exec(o))!==null;)a.push({start:u.index,length:u[0].length,error:`Value "${u[0]}" can't be safely passed as a path parameter`});if(a.sort((m,p)=>m.start-p.start),a.length>0){let m=0;const p=a.reduce((f,d)=>{const b=" ".repeat(d.start-m),w="^".repeat(d.length);return m=d.start+d.length,f+b+w},"");throw new x(`Path parameters result in path with invalid segments:
${a.map(f=>f.error).join(`
`)}
${i}
${p}`)}return i},_=Ri(pr);let fr=class extends v{list(e,n={},s){return this._client.getAPIList(_`/chat/completions/${e}/messages`,E,{query:n,...s})}};function _t(t){return t!==void 0&&"function"in t&&t.function!==void 0}function $i(t,e){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),n}function bn(t){return t?.$brand==="auto-parseable-response-format"}function Ze(t){return t?.$brand==="auto-parseable-tool"}function Pi(t,e){return!e||!hr(e)?{...t,choices:t.choices.map(n=>(mr(n.message.tool_calls),{...n,message:{...n.message,parsed:null,...n.message.tool_calls?{tool_calls:n.message.tool_calls}:void 0}}))}:vn(t,e)}function vn(t,e){const n=t.choices.map(s=>{if(s.finish_reason==="length")throw new Vs;if(s.finish_reason==="content_filter")throw new Xs;return mr(s.message.tool_calls),{...s,message:{...s.message,...s.message.tool_calls?{tool_calls:s.message.tool_calls?.map(r=>Mi(e,r))??void 0}:void 0,parsed:s.message.content&&!s.message.refusal?Ei(e,s.message.content):null}}});return{...t,choices:n}}function Ei(t,e){return t.response_format?.type!=="json_schema"?null:t.response_format?.type==="json_schema"?"$parseRaw"in t.response_format?t.response_format.$parseRaw(e):JSON.parse(e):null}function Mi(t,e){const n=t.tools?.find(s=>_t(s)&&s.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:Ze(n)?n.$parseRaw(e.function.arguments):n?.function.strict?JSON.parse(e.function.arguments):null}}}function Ni(t,e){if(!t||!("tools"in t)||!t.tools)return!1;const n=t.tools?.find(s=>_t(s)&&s.function?.name===e.function.name);return _t(n)&&(Ze(n)||n?.function.strict||!1)}function hr(t){return bn(t.response_format)?!0:t.tools?.some(e=>Ze(e)||e.type==="function"&&e.function.strict===!0)??!1}function mr(t){for(const e of t||[])if(e.type!=="function")throw new x(`Currently only \`function\` tool calls are supported; Received \`${e.type}\``)}function ji(t){for(const e of t??[]){if(e.type!=="function")throw new x(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new x(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}const yt=t=>t?.role==="assistant",gr=t=>t?.role==="tool";var rn,ot,ut,Ne,je,lt,Ue,ue,Le,wt,bt,Ie,_r;class xn{constructor(){rn.add(this),this.controller=new AbortController,ot.set(this,void 0),ut.set(this,()=>{}),Ne.set(this,()=>{}),je.set(this,void 0),lt.set(this,()=>{}),Ue.set(this,()=>{}),ue.set(this,{}),Le.set(this,!1),wt.set(this,!1),bt.set(this,!1),Ie.set(this,!1),O(this,ot,new Promise((e,n)=>{O(this,ut,e,"f"),O(this,Ne,n,"f")})),O(this,je,new Promise((e,n)=>{O(this,lt,e,"f"),O(this,Ue,n,"f")})),c(this,ot,"f").catch(()=>{}),c(this,je,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},c(this,rn,"m",_r).bind(this))},0)}_connected(){this.ended||(c(this,ut,"f").call(this),this._emit("connect"))}get ended(){return c(this,Le,"f")}get errored(){return c(this,wt,"f")}get aborted(){return c(this,bt,"f")}abort(){this.controller.abort()}on(e,n){return(c(this,ue,"f")[e]||(c(this,ue,"f")[e]=[])).push({listener:n}),this}off(e,n){const s=c(this,ue,"f")[e];if(!s)return this;const r=s.findIndex(a=>a.listener===n);return r>=0&&s.splice(r,1),this}once(e,n){return(c(this,ue,"f")[e]||(c(this,ue,"f")[e]=[])).push({listener:n,once:!0}),this}emitted(e){return new Promise((n,s)=>{O(this,Ie,!0),e!=="error"&&this.once("error",s),this.once(e,n)})}async done(){O(this,Ie,!0),await c(this,je,"f")}_emit(e,...n){if(c(this,Le,"f"))return;e==="end"&&(O(this,Le,!0),c(this,lt,"f").call(this));const s=c(this,ue,"f")[e];if(s&&(c(this,ue,"f")[e]=s.filter(r=>!r.once),s.forEach(({listener:r})=>r(...n))),e==="abort"){const r=n[0];!c(this,Ie,"f")&&!s?.length&&Promise.reject(r),c(this,Ne,"f").call(this,r),c(this,Ue,"f").call(this,r),this._emit("end");return}if(e==="error"){const r=n[0];!c(this,Ie,"f")&&!s?.length&&Promise.reject(r),c(this,Ne,"f").call(this,r),c(this,Ue,"f").call(this,r),this._emit("end")}}_emitFinal(){}}ot=new WeakMap,ut=new WeakMap,Ne=new WeakMap,je=new WeakMap,lt=new WeakMap,Ue=new WeakMap,ue=new WeakMap,Le=new WeakMap,wt=new WeakMap,bt=new WeakMap,Ie=new WeakMap,rn=new WeakSet,_r=function(e){if(O(this,wt,!0),e instanceof Error&&e.name==="AbortError"&&(e=new Y),e instanceof Y)return O(this,bt,!0),this._emit("abort",e);if(e instanceof x)return this._emit("error",e);if(e instanceof Error){const n=new x(e.message);return n.cause=e,this._emit("error",n)}return this._emit("error",new x(String(e)))};function Ui(t){return typeof t.parse=="function"}var z,an,vt,on,un,ln,yr,wr;const Li=10;class br extends xn{constructor(){super(...arguments),z.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const n=e.choices[0]?.message;return n&&this._addMessage(n),e}_addMessage(e,n=!0){if("content"in e||(e.content=null),this.messages.push(e),n){if(this._emit("message",e),gr(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(yt(e)&&e.tool_calls)for(const s of e.tool_calls)s.type==="function"&&this._emit("functionToolCall",s.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new x("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),c(this,z,"m",an).call(this)}async finalMessage(){return await this.done(),c(this,z,"m",vt).call(this)}async finalFunctionToolCall(){return await this.done(),c(this,z,"m",on).call(this)}async finalFunctionToolCallResult(){return await this.done(),c(this,z,"m",un).call(this)}async totalUsage(){return await this.done(),c(this,z,"m",ln).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const n=c(this,z,"m",vt).call(this);n&&this._emit("finalMessage",n);const s=c(this,z,"m",an).call(this);s&&this._emit("finalContent",s);const r=c(this,z,"m",on).call(this);r&&this._emit("finalFunctionToolCall",r);const a=c(this,z,"m",un).call(this);a!=null&&this._emit("finalFunctionToolCallResult",a),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",c(this,z,"m",ln).call(this))}async _createChatCompletion(e,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),c(this,z,"m",yr).call(this,n);const a=await e.chat.completions.create({...n,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion(vn(a,n))}async _runChatCompletion(e,n,s){for(const r of n.messages)this._addMessage(r,!1);return await this._createChatCompletion(e,n,s)}async _runTools(e,n,s){const r="tool",{tool_choice:a="auto",stream:i,...o}=n,l=typeof a!="string"&&a.type==="function"&&a?.function?.name,{maxChatCompletions:u=Li}=s||{},m=n.tools.map(d=>{if(Ze(d)){if(!d.$callback)throw new x("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:d.$callback,name:d.function.name,description:d.function.description||"",parameters:d.function.parameters,parse:d.$parseRaw,strict:!0}}}return d}),p={};for(const d of m)d.type==="function"&&(p[d.function.name||d.function.function.name]=d.function);const f="tools"in n?m.map(d=>d.type==="function"?{type:"function",function:{name:d.function.name||d.function.function.name,parameters:d.function.parameters,description:d.function.description,strict:d.function.strict}}:d):void 0;for(const d of n.messages)this._addMessage(d,!1);for(let d=0;d<u;++d){const w=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:f,messages:[...this.messages]},s)).choices[0]?.message;if(!w)throw new x("missing message in ChatCompletion response");if(!w.tool_calls?.length)return;for(const $ of w.tool_calls){if($.type!=="function")continue;const h=$.id,{name:g,arguments:T}=$.function,C=p[g];if(C){if(l&&l!==g){const F=`Invalid tool_call: ${JSON.stringify(g)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:r,tool_call_id:h,content:F});continue}}else{const F=`Invalid tool_call: ${JSON.stringify(g)}. Available options are: ${Object.keys(p).map(L=>JSON.stringify(L)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:h,content:F});continue}let Z;try{Z=Ui(C)?await C.parse(T):T}catch(F){const L=F instanceof Error?F.message:String(F);this._addMessage({role:r,tool_call_id:h,content:L});continue}const U=await C.function(Z,this),R=c(this,z,"m",wr).call(this,U);if(this._addMessage({role:r,tool_call_id:h,content:R}),l)return}}}}z=new WeakSet,an=function(){return c(this,z,"m",vt).call(this).content??null},vt=function(){let e=this.messages.length;for(;e-- >0;){const n=this.messages[e];if(yt(n))return{...n,content:n.content??null,refusal:n.refusal??null}}throw new x("stream ended without producing a ChatCompletionMessage with role=assistant")},on=function(){for(let e=this.messages.length-1;e>=0;e--){const n=this.messages[e];if(yt(n)&&n?.tool_calls?.length)return n.tool_calls.filter(s=>s.type==="function").at(-1)?.function}},un=function(){for(let e=this.messages.length-1;e>=0;e--){const n=this.messages[e];if(gr(n)&&n.content!=null&&typeof n.content=="string"&&this.messages.some(s=>s.role==="assistant"&&s.tool_calls?.some(r=>r.type==="function"&&r.id===n.tool_call_id)))return n.content}},ln=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:n}of this._chatCompletions)n&&(e.completion_tokens+=n.completion_tokens,e.prompt_tokens+=n.prompt_tokens,e.total_tokens+=n.total_tokens);return e},yr=function(e){if(e.n!=null&&e.n>1)throw new x("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},wr=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class On extends br{static runTools(e,n,s){const r=new On,a={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,n,a)),r}_addMessage(e,n=!0){super._addMessage(e,n),yt(e)&&e.content&&this._emit("content",e.content)}}const vr=1,xr=2,Or=4,Ir=8,kr=16,Tr=32,Sr=64,Cr=128,Ar=256,Rr=Cr|Ar,$r=kr|Tr|Rr|Sr,Pr=vr|xr|$r,Er=Or|Ir,Di=Pr|Er,D={STR:vr,NUM:xr,ARR:Or,OBJ:Ir,NULL:kr,BOOL:Tr,NAN:Sr,INFINITY:Cr,MINUS_INFINITY:Ar,INF:Rr,SPECIAL:$r,ATOM:Pr,COLLECTION:Er,ALL:Di};class Fi extends Error{}class Bi extends Error{}function Wi(t,e=D.ALL){if(typeof t!="string")throw new TypeError(`expecting str, got ${typeof t}`);if(!t.trim())throw new Error(`${t} is empty`);return qi(t.trim(),e)}const qi=(t,e)=>{const n=t.length;let s=0;const r=f=>{throw new Fi(`${f} at position ${s}`)},a=f=>{throw new Bi(`${f} at position ${s}`)},i=()=>(p(),s>=n&&r("Unexpected end of input"),t[s]==='"'?o():t[s]==="{"?l():t[s]==="["?u():t.substring(s,s+4)==="null"||D.NULL&e&&n-s<4&&"null".startsWith(t.substring(s))?(s+=4,null):t.substring(s,s+4)==="true"||D.BOOL&e&&n-s<4&&"true".startsWith(t.substring(s))?(s+=4,!0):t.substring(s,s+5)==="false"||D.BOOL&e&&n-s<5&&"false".startsWith(t.substring(s))?(s+=5,!1):t.substring(s,s+8)==="Infinity"||D.INFINITY&e&&n-s<8&&"Infinity".startsWith(t.substring(s))?(s+=8,1/0):t.substring(s,s+9)==="-Infinity"||D.MINUS_INFINITY&e&&1<n-s&&n-s<9&&"-Infinity".startsWith(t.substring(s))?(s+=9,-1/0):t.substring(s,s+3)==="NaN"||D.NAN&e&&n-s<3&&"NaN".startsWith(t.substring(s))?(s+=3,NaN):m()),o=()=>{const f=s;let d=!1;for(s++;s<n&&(t[s]!=='"'||d&&t[s-1]==="\\");)d=t[s]==="\\"?!d:!1,s++;if(t.charAt(s)=='"')try{return JSON.parse(t.substring(f,++s-Number(d)))}catch(b){a(String(b))}else if(D.STR&e)try{return JSON.parse(t.substring(f,s-Number(d))+'"')}catch{return JSON.parse(t.substring(f,t.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},l=()=>{s++,p();const f={};try{for(;t[s]!=="}";){if(p(),s>=n&&D.OBJ&e)return f;const d=o();p(),s++;try{const b=i();Object.defineProperty(f,d,{value:b,writable:!0,enumerable:!0,configurable:!0})}catch(b){if(D.OBJ&e)return f;throw b}p(),t[s]===","&&s++}}catch{if(D.OBJ&e)return f;r("Expected '}' at end of object")}return s++,f},u=()=>{s++;const f=[];try{for(;t[s]!=="]";)f.push(i()),p(),t[s]===","&&s++}catch{if(D.ARR&e)return f;r("Expected ']' at end of array")}return s++,f},m=()=>{if(s===0){t==="-"&&D.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(t)}catch(d){if(D.NUM&e)try{return t[t.length-1]==="."?JSON.parse(t.substring(0,t.lastIndexOf("."))):JSON.parse(t.substring(0,t.lastIndexOf("e")))}catch{}a(String(d))}}const f=s;for(t[s]==="-"&&s++;t[s]&&!",]}".includes(t[s]);)s++;s==n&&!(D.NUM&e)&&r("Unterminated number literal");try{return JSON.parse(t.substring(f,s))}catch{t.substring(f,s)==="-"&&D.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(t.substring(f,t.lastIndexOf("e")))}catch(b){a(String(b))}}},p=()=>{for(;s<n&&` 
\r	`.includes(t[s]);)s++};return i()},fs=t=>Wi(t,D.ALL^D.NUM);var N,oe,be,ce,Kt,et,Zt,zt,Ht,tt,Vt,hs;class Je extends br{constructor(e){super(),N.add(this),oe.set(this,void 0),be.set(this,void 0),ce.set(this,void 0),O(this,oe,e),O(this,be,[])}get currentChatCompletionSnapshot(){return c(this,ce,"f")}static fromReadableStream(e){const n=new Je(null);return n._run(()=>n._fromReadableStream(e)),n}static createChatCompletion(e,n,s){const r=new Je(n);return r._run(()=>r._runChatCompletion(e,{...n,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(e,n,s){super._createChatCompletion;const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),c(this,N,"m",Kt).call(this);const a=await e.chat.completions.create({...n,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(const i of a)c(this,N,"m",Zt).call(this,i);if(a.controller.signal?.aborted)throw new Y;return this._addChatCompletion(c(this,N,"m",tt).call(this))}async _fromReadableStream(e,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),c(this,N,"m",Kt).call(this),this._connected();const r=ie.fromReadableStream(e,this.controller);let a;for await(const i of r)a&&a!==i.id&&this._addChatCompletion(c(this,N,"m",tt).call(this)),c(this,N,"m",Zt).call(this,i),a=i.id;if(r.controller.signal?.aborted)throw new Y;return this._addChatCompletion(c(this,N,"m",tt).call(this))}[(oe=new WeakMap,be=new WeakMap,ce=new WeakMap,N=new WeakSet,Kt=function(){this.ended||O(this,ce,void 0)},et=function(n){let s=c(this,be,"f")[n.index];return s||(s={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},c(this,be,"f")[n.index]=s,s)},Zt=function(n){if(this.ended)return;const s=c(this,N,"m",hs).call(this,n);this._emit("chunk",n,s);for(const r of n.choices){const a=s.choices[r.index];r.delta.content!=null&&a.message?.role==="assistant"&&a.message?.content&&(this._emit("content",r.delta.content,a.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:a.message.content,parsed:a.message.parsed})),r.delta.refusal!=null&&a.message?.role==="assistant"&&a.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:a.message.refusal}),r.logprobs?.content!=null&&a.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:a.logprobs?.content??[]}),r.logprobs?.refusal!=null&&a.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:a.logprobs?.refusal??[]});const i=c(this,N,"m",et).call(this,a);a.finish_reason&&(c(this,N,"m",Ht).call(this,a),i.current_tool_call_index!=null&&c(this,N,"m",zt).call(this,a,i.current_tool_call_index));for(const o of r.delta.tool_calls??[])i.current_tool_call_index!==o.index&&(c(this,N,"m",Ht).call(this,a),i.current_tool_call_index!=null&&c(this,N,"m",zt).call(this,a,i.current_tool_call_index)),i.current_tool_call_index=o.index;for(const o of r.delta.tool_calls??[]){const l=a.message.tool_calls?.[o.index];l?.type&&(l?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:l.function?.name,index:o.index,arguments:l.function.arguments,parsed_arguments:l.function.parsed_arguments,arguments_delta:o.function?.arguments??""}):(l?.type,void 0))}}},zt=function(n,s){if(c(this,N,"m",et).call(this,n).done_tool_calls.has(s))return;const a=n.message.tool_calls?.[s];if(!a)throw new Error("no tool call snapshot");if(!a.type)throw new Error("tool call snapshot missing `type`");if(a.type==="function"){const i=c(this,oe,"f")?.tools?.find(o=>_t(o)&&o.function.name===a.function.name);this._emit("tool_calls.function.arguments.done",{name:a.function.name,index:s,arguments:a.function.arguments,parsed_arguments:Ze(i)?i.$parseRaw(a.function.arguments):i?.function.strict?JSON.parse(a.function.arguments):null})}else a.type},Ht=function(n){const s=c(this,N,"m",et).call(this,n);if(n.message.content&&!s.content_done){s.content_done=!0;const r=c(this,N,"m",Vt).call(this);this._emit("content.done",{content:n.message.content,parsed:r?r.$parseRaw(n.message.content):null})}n.message.refusal&&!s.refusal_done&&(s.refusal_done=!0,this._emit("refusal.done",{refusal:n.message.refusal})),n.logprobs?.content&&!s.logprobs_content_done&&(s.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:n.logprobs.content})),n.logprobs?.refusal&&!s.logprobs_refusal_done&&(s.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:n.logprobs.refusal}))},tt=function(){if(this.ended)throw new x("stream has ended, this shouldn't happen");const n=c(this,ce,"f");if(!n)throw new x("request ended without sending any chunks");return O(this,ce,void 0),O(this,be,[]),Ji(n,c(this,oe,"f"))},Vt=function(){const n=c(this,oe,"f")?.response_format;return bn(n)?n:null},hs=function(n){var s,r,a,i;let o=c(this,ce,"f");const{choices:l,...u}=n;o?Object.assign(o,u):o=O(this,ce,{...u,choices:[]});for(const{delta:m,finish_reason:p,index:f,logprobs:d=null,...b}of n.choices){let w=o.choices[f];if(w||(w=o.choices[f]={finish_reason:p,index:f,message:{},logprobs:d,...b}),d)if(!w.logprobs)w.logprobs=Object.assign({},d);else{const{content:U,refusal:R,...F}=d;Object.assign(w.logprobs,F),U&&((s=w.logprobs).content??(s.content=[]),w.logprobs.content.push(...U)),R&&((r=w.logprobs).refusal??(r.refusal=[]),w.logprobs.refusal.push(...R))}if(p&&(w.finish_reason=p,c(this,oe,"f")&&hr(c(this,oe,"f")))){if(p==="length")throw new Vs;if(p==="content_filter")throw new Xs}if(Object.assign(w,b),!m)continue;const{content:$,refusal:h,function_call:g,role:T,tool_calls:C,...Z}=m;if(Object.assign(w.message,Z),h&&(w.message.refusal=(w.message.refusal||"")+h),T&&(w.message.role=T),g&&(w.message.function_call?(g.name&&(w.message.function_call.name=g.name),g.arguments&&((a=w.message.function_call).arguments??(a.arguments=""),w.message.function_call.arguments+=g.arguments)):w.message.function_call=g),$&&(w.message.content=(w.message.content||"")+$,!w.message.refusal&&c(this,N,"m",Vt).call(this)&&(w.message.parsed=fs(w.message.content))),C){w.message.tool_calls||(w.message.tool_calls=[]);for(const{index:U,id:R,type:F,function:L,...P}of C){const M=(i=w.message.tool_calls)[U]??(i[U]={});Object.assign(M,P),R&&(M.id=R),F&&(M.type=F),L&&(M.function??(M.function={name:L.name??"",arguments:""})),L?.name&&(M.function.name=L.name),L?.arguments&&(M.function.arguments+=L.arguments,Ni(c(this,oe,"f"),M)&&(M.function.parsed_arguments=fs(M.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],n=[];let s=!1;return this.on("chunk",r=>{const a=n.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of n)r.resolve(void 0);n.length=0}),this.on("abort",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),this.on("error",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new ie(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Ji(t,e){const{id:n,choices:s,created:r,model:a,system_fingerprint:i,...o}=t,l={...o,id:n,choices:s.map(({message:u,finish_reason:m,index:p,logprobs:f,...d})=>{if(!m)throw new x(`missing finish_reason for choice ${p}`);const{content:b=null,function_call:w,tool_calls:$,...h}=u,g=u.role;if(!g)throw new x(`missing role for choice ${p}`);if(w){const{arguments:T,name:C}=w;if(T==null)throw new x(`missing function_call.arguments for choice ${p}`);if(!C)throw new x(`missing function_call.name for choice ${p}`);return{...d,message:{content:b,function_call:{arguments:T,name:C},role:g,refusal:u.refusal??null},finish_reason:m,index:p,logprobs:f}}return $?{...d,index:p,finish_reason:m,logprobs:f,message:{...h,role:g,content:b,refusal:u.refusal??null,tool_calls:$.map((T,C)=>{const{function:Z,type:U,id:R,...F}=T,{arguments:L,name:P,...M}=Z||{};if(R==null)throw new x(`missing choices[${p}].tool_calls[${C}].id
${nt(t)}`);if(U==null)throw new x(`missing choices[${p}].tool_calls[${C}].type
${nt(t)}`);if(P==null)throw new x(`missing choices[${p}].tool_calls[${C}].function.name
${nt(t)}`);if(L==null)throw new x(`missing choices[${p}].tool_calls[${C}].function.arguments
${nt(t)}`);return{...F,id:R,type:U,function:{...M,name:P,arguments:L}}})}}:{...d,message:{...h,content:b,role:g,refusal:u.refusal??null},finish_reason:m,index:p,logprobs:f}}),created:r,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return Pi(l,e)}function nt(t){return JSON.stringify(t)}class xt extends Je{static fromReadableStream(e){const n=new xt(null);return n._run(()=>n._fromReadableStream(e)),n}static runTools(e,n,s){const r=new xt(n),a={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,n,a)),r}}let In=class extends v{constructor(){super(...arguments),this.messages=new fr(this._client)}create(e,n){return this._client.post("/chat/completions",{body:e,...n,stream:e.stream??!1})}retrieve(e,n){return this._client.get(_`/chat/completions/${e}`,n)}update(e,n,s){return this._client.post(_`/chat/completions/${e}`,{body:n,...s})}list(e={},n){return this._client.getAPIList("/chat/completions",E,{query:e,...n})}delete(e,n){return this._client.delete(_`/chat/completions/${e}`,n)}parse(e,n){return ji(e.tools),this._client.chat.completions.create(e,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(s=>vn(s,e))}runTools(e,n){return e.stream?xt.runTools(this._client,e,n):On.runTools(this._client,e,n)}stream(e,n){return Je.createChatCompletion(this._client,e,n)}};In.Messages=fr;class kn extends v{constructor(){super(...arguments),this.completions=new In(this._client)}}kn.Completions=In;const Mr=Symbol("brand.privateNullableHeaders");function*Ki(t){if(!t)return;if(Mr in t){const{values:s,nulls:r}=t;yield*s.entries();for(const a of r)yield[a,null];return}let e=!1,n;t instanceof Headers?n=t.entries():Qn(t)?n=t:(e=!0,n=Object.entries(t??{}));for(let s of n){const r=s[0];if(typeof r!="string")throw new TypeError("expected header name to be a string");const a=Qn(s[1])?s[1]:[s[1]];let i=!1;for(const o of a)o!==void 0&&(e&&!i&&(i=!0,yield[r,null]),yield[r,o])}}const y=t=>{const e=new Headers,n=new Set;for(const s of t){const r=new Set;for(const[a,i]of Ki(s)){const o=a.toLowerCase();r.has(o)||(e.delete(a),r.add(o)),i===null?(e.delete(a),n.add(o)):(e.append(a,i),n.delete(o))}}return{[Mr]:!0,values:e,nulls:n}};class Nr extends v{create(e,n){return this._client.post("/audio/speech",{body:e,...n,headers:y([{Accept:"application/octet-stream"},n?.headers]),__binaryResponse:!0})}}class jr extends v{create(e,n){return this._client.post("/audio/transcriptions",we({body:e,...n,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class Ur extends v{create(e,n){return this._client.post("/audio/translations",we({body:e,...n,__metadata:{model:e.model}},this._client))}}class ze extends v{constructor(){super(...arguments),this.transcriptions=new jr(this._client),this.translations=new Ur(this._client),this.speech=new Nr(this._client)}}ze.Transcriptions=jr;ze.Translations=Ur;ze.Speech=Nr;class Lr extends v{create(e,n){return this._client.post("/batches",{body:e,...n})}retrieve(e,n){return this._client.get(_`/batches/${e}`,n)}list(e={},n){return this._client.getAPIList("/batches",E,{query:e,...n})}cancel(e,n){return this._client.post(_`/batches/${e}/cancel`,n)}}class Dr extends v{create(e,n){return this._client.post("/assistants",{body:e,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,n){return this._client.get(_`/assistants/${e}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,n,s){return this._client.post(_`/assistants/${e}`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},n){return this._client.getAPIList("/assistants",E,{query:e,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,n){return this._client.delete(_`/assistants/${e}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}let Fr=class extends v{create(e,n){return this._client.post("/realtime/sessions",{body:e,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}};class Br extends v{create(e,n){return this._client.post("/realtime/transcription_sessions",{body:e,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}let Nt=class extends v{constructor(){super(...arguments),this.sessions=new Fr(this._client),this.transcriptionSessions=new Br(this._client)}};Nt.Sessions=Fr;Nt.TranscriptionSessions=Br;class Wr extends v{create(e,n){return this._client.post("/chatkit/sessions",{body:e,...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}cancel(e,n){return this._client.post(_`/chatkit/sessions/${e}/cancel`,{...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}}let qr=class extends v{retrieve(e,n){return this._client.get(_`/chatkit/threads/${e}`,{...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}list(e={},n){return this._client.getAPIList("/chatkit/threads",gt,{query:e,...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}delete(e,n){return this._client.delete(_`/chatkit/threads/${e}`,{...n,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}listItems(e,n={},s){return this._client.getAPIList(_`/chatkit/threads/${e}/items`,gt,{query:n,...s,headers:y([{"OpenAI-Beta":"chatkit_beta=v1"},s?.headers])})}};class jt extends v{constructor(){super(...arguments),this.sessions=new Wr(this._client),this.threads=new qr(this._client)}}jt.Sessions=Wr;jt.Threads=qr;class Jr extends v{create(e,n,s){return this._client.post(_`/threads/${e}/messages`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,n,s){const{thread_id:r}=n;return this._client.get(_`/threads/${r}/messages/${e}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,n,s){const{thread_id:r,...a}=n;return this._client.post(_`/threads/${r}/messages/${e}`,{body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,n={},s){return this._client.getAPIList(_`/threads/${e}/messages`,E,{query:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,n,s){const{thread_id:r}=n;return this._client.delete(_`/threads/${r}/messages/${e}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class Kr extends v{retrieve(e,n,s){const{thread_id:r,run_id:a,...i}=n;return this._client.get(_`/threads/${r}/runs/${a}/steps/${e}`,{query:i,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,n,s){const{thread_id:r,...a}=n;return this._client.getAPIList(_`/threads/${r}/runs/${e}/steps`,E,{query:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}const Zi=t=>{if(typeof Buffer<"u"){const e=Buffer.from(t,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(t),n=e.length,s=new Uint8Array(n);for(let r=0;r<n;r++)s[r]=e.charCodeAt(r);return Array.from(new Float32Array(s.buffer))}};var zi={};const ve=t=>{if(typeof globalThis.process<"u")return zi?.[t]?.trim()??void 0;if(typeof globalThis.Deno<"u")return globalThis.Deno.env?.get?.(t)?.trim()};var W,ge,cn,ae,ct,se,_e,Te,me,Ot,G,dt,pt,We,De,Fe,ms,gs,_s,ys,ws,bs,vs;class qe extends xn{constructor(){super(...arguments),W.add(this),cn.set(this,[]),ae.set(this,{}),ct.set(this,{}),se.set(this,void 0),_e.set(this,void 0),Te.set(this,void 0),me.set(this,void 0),Ot.set(this,void 0),G.set(this,void 0),dt.set(this,void 0),pt.set(this,void 0),We.set(this,void 0)}[(cn=new WeakMap,ae=new WeakMap,ct=new WeakMap,se=new WeakMap,_e=new WeakMap,Te=new WeakMap,me=new WeakMap,Ot=new WeakMap,G=new WeakMap,dt=new WeakMap,pt=new WeakMap,We=new WeakMap,W=new WeakSet,Symbol.asyncIterator)](){const e=[],n=[];let s=!1;return this.on("event",r=>{const a=n.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of n)r.resolve(void 0);n.length=0}),this.on("abort",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),this.on("error",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const n=new ge;return n._run(()=>n._fromReadableStream(e)),n}async _fromReadableStream(e,n){const s=n?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),this._connected();const r=ie.fromReadableStream(e,this.controller);for await(const a of r)c(this,W,"m",De).call(this,a);if(r.controller.signal?.aborted)throw new Y;return this._addRun(c(this,W,"m",Fe).call(this))}toReadableStream(){return new ie(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,n,s,r){const a=new ge;return a._run(()=>a._runToolAssistantStream(e,n,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,n,s,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},o=await e.submitToolOutputs(n,i,{...r,signal:this.controller.signal});this._connected();for await(const l of o)c(this,W,"m",De).call(this,l);if(o.controller.signal?.aborted)throw new Y;return this._addRun(c(this,W,"m",Fe).call(this))}static createThreadAssistantStream(e,n,s){const r=new ge;return r._run(()=>r._threadAssistantStream(e,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(e,n,s,r){const a=new ge;return a._run(()=>a._runAssistantStream(e,n,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return c(this,dt,"f")}currentRun(){return c(this,pt,"f")}currentMessageSnapshot(){return c(this,se,"f")}currentRunStepSnapshot(){return c(this,We,"f")}async finalRunSteps(){return await this.done(),Object.values(c(this,ae,"f"))}async finalMessages(){return await this.done(),Object.values(c(this,ct,"f"))}async finalRun(){if(await this.done(),!c(this,_e,"f"))throw Error("Final run was not received.");return c(this,_e,"f")}async _createThreadAssistantStream(e,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const a={...n,stream:!0},i=await e.createAndRun(a,{...s,signal:this.controller.signal});this._connected();for await(const o of i)c(this,W,"m",De).call(this,o);if(i.controller.signal?.aborted)throw new Y;return this._addRun(c(this,W,"m",Fe).call(this))}async _createAssistantStream(e,n,s,r){const a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...s,stream:!0},o=await e.create(n,i,{...r,signal:this.controller.signal});this._connected();for await(const l of o)c(this,W,"m",De).call(this,l);if(o.controller.signal?.aborted)throw new Y;return this._addRun(c(this,W,"m",Fe).call(this))}static accumulateDelta(e,n){for(const[s,r]of Object.entries(n)){if(!e.hasOwnProperty(s)){e[s]=r;continue}let a=e[s];if(a==null){e[s]=r;continue}if(s==="index"||s==="type"){e[s]=r;continue}if(typeof a=="string"&&typeof r=="string")a+=r;else if(typeof a=="number"&&typeof r=="number")a+=r;else if(Wt(a)&&Wt(r))a=this.accumulateDelta(a,r);else if(Array.isArray(a)&&Array.isArray(r)){if(a.every(i=>typeof i=="string"||typeof i=="number")){a.push(...r);continue}for(const i of r){if(!Wt(i))throw new Error(`Expected array delta entry to be an object but got: ${i}`);const o=i.index;if(o==null)throw console.error(i),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const l=a[o];l==null?a.push(i):a[o]=this.accumulateDelta(l,i)}continue}else throw Error(`Unhandled record type: ${s}, deltaValue: ${r}, accValue: ${a}`);e[s]=a}return e}_addRun(e){return e}async _threadAssistantStream(e,n,s){return await this._createThreadAssistantStream(n,e,s)}async _runAssistantStream(e,n,s,r){return await this._createAssistantStream(n,e,s,r)}async _runToolAssistantStream(e,n,s,r){return await this._createToolAssistantStream(n,e,s,r)}}ge=qe,De=function(e){if(!this.ended)switch(O(this,dt,e),c(this,W,"m",_s).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":c(this,W,"m",vs).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":c(this,W,"m",gs).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":c(this,W,"m",ms).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Fe=function(){if(this.ended)throw new x("stream has ended, this shouldn't happen");if(!c(this,_e,"f"))throw Error("Final run has not been received");return c(this,_e,"f")},ms=function(e){const[n,s]=c(this,W,"m",ws).call(this,e,c(this,se,"f"));O(this,se,n),c(this,ct,"f")[n.id]=n;for(const r of s){const a=n.content[r.index];a?.type=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,n),e.data.delta.content)for(const r of e.data.delta.content){if(r.type=="text"&&r.text){let a=r.text,i=n.content[r.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=c(this,Te,"f")){if(c(this,me,"f"))switch(c(this,me,"f").type){case"text":this._emit("textDone",c(this,me,"f").text,c(this,se,"f"));break;case"image_file":this._emit("imageFileDone",c(this,me,"f").image_file,c(this,se,"f"));break}O(this,Te,r.index)}O(this,me,n.content[r.index])}break;case"thread.message.completed":case"thread.message.incomplete":if(c(this,Te,"f")!==void 0){const r=e.data.content[c(this,Te,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,c(this,se,"f"));break;case"text":this._emit("textDone",r.text,c(this,se,"f"));break}}c(this,se,"f")&&this._emit("messageDone",e.data),O(this,se,void 0)}},gs=function(e){const n=c(this,W,"m",ys).call(this,e);switch(O(this,We,n),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const s=e.data.delta;if(s.step_details&&s.step_details.type=="tool_calls"&&s.step_details.tool_calls&&n.step_details.type=="tool_calls")for(const a of s.step_details.tool_calls)a.index==c(this,Ot,"f")?this._emit("toolCallDelta",a,n.step_details.tool_calls[a.index]):(c(this,G,"f")&&this._emit("toolCallDone",c(this,G,"f")),O(this,Ot,a.index),O(this,G,n.step_details.tool_calls[a.index]),c(this,G,"f")&&this._emit("toolCallCreated",c(this,G,"f")));this._emit("runStepDelta",e.data.delta,n);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":O(this,We,void 0),e.data.step_details.type=="tool_calls"&&c(this,G,"f")&&(this._emit("toolCallDone",c(this,G,"f")),O(this,G,void 0)),this._emit("runStepDone",e.data,n);break}},_s=function(e){c(this,cn,"f").push(e),this._emit("event",e)},ys=function(e){switch(e.event){case"thread.run.step.created":return c(this,ae,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let n=c(this,ae,"f")[e.data.id];if(!n)throw Error("Received a RunStepDelta before creation of a snapshot");let s=e.data;if(s.delta){const r=ge.accumulateDelta(n,s.delta);c(this,ae,"f")[e.data.id]=r}return c(this,ae,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":c(this,ae,"f")[e.data.id]=e.data;break}if(c(this,ae,"f")[e.data.id])return c(this,ae,"f")[e.data.id];throw new Error("No snapshot available")},ws=function(e,n){let s=[];switch(e.event){case"thread.message.created":return[e.data,s];case"thread.message.delta":if(!n)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const a of r.delta.content)if(a.index in n.content){let i=n.content[a.index];n.content[a.index]=c(this,W,"m",bs).call(this,a,i)}else n.content[a.index]=a,s.push(a);return[n,s];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(n)return[n,s];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},bs=function(e,n){return ge.accumulateDelta(n,e)},vs=function(e){switch(O(this,pt,e.data),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":O(this,_e,e.data),c(this,G,"f")&&(this._emit("toolCallDone",c(this,G,"f")),O(this,G,void 0));break}};let Tn=class extends v{constructor(){super(...arguments),this.steps=new Kr(this._client)}create(e,n,s){const{include:r,...a}=n;return this._client.post(_`/threads/${e}/runs`,{query:{include:r},body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:n.stream??!1})}retrieve(e,n,s){const{thread_id:r}=n;return this._client.get(_`/threads/${r}/runs/${e}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,n,s){const{thread_id:r,...a}=n;return this._client.post(_`/threads/${r}/runs/${e}`,{body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,n={},s){return this._client.getAPIList(_`/threads/${e}/runs`,E,{query:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,n,s){const{thread_id:r}=n;return this._client.post(_`/threads/${r}/runs/${e}/cancel`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,n,s){const r=await this.create(e,n,s);return await this.poll(r.id,{thread_id:e},s)}createAndStream(e,n,s){return qe.createAssistantStream(e,this._client.beta.threads.runs,n,s)}async poll(e,n,s){const r=y([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:a,response:i}=await this.retrieve(e,n,{...s,headers:{...s?.headers,...r}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const l=i.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(o=u)}}await Ke(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,n,s){return qe.createAssistantStream(e,this._client.beta.threads.runs,n,s)}submitToolOutputs(e,n,s){const{thread_id:r,...a}=n;return this._client.post(_`/threads/${r}/runs/${e}/submit_tool_outputs`,{body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers]),stream:n.stream??!1})}async submitToolOutputsAndPoll(e,n,s){const r=await this.submitToolOutputs(e,n,s);return await this.poll(r.id,n,s)}submitToolOutputsStream(e,n,s){return qe.createToolAssistantStream(e,this._client.beta.threads.runs,n,s)}};Tn.Steps=Kr;class Ut extends v{constructor(){super(...arguments),this.runs=new Tn(this._client),this.messages=new Jr(this._client)}create(e={},n){return this._client.post("/threads",{body:e,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,n){return this._client.get(_`/threads/${e}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,n,s){return this._client.post(_`/threads/${e}`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,n){return this._client.delete(_`/threads/${e}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}createAndRun(e,n){return this._client.post("/threads/runs",{body:e,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,n){const s=await this.createAndRun(e,n);return await this.runs.poll(s.id,{thread_id:s.thread_id},n)}createAndRunStream(e,n){return qe.createThreadAssistantStream(e,this._client.beta.threads,n)}}Ut.Runs=Tn;Ut.Messages=Jr;class Ce extends v{constructor(){super(...arguments),this.realtime=new Nt(this._client),this.chatkit=new jt(this._client),this.assistants=new Dr(this._client),this.threads=new Ut(this._client)}}Ce.Realtime=Nt;Ce.ChatKit=jt;Ce.Assistants=Dr;Ce.Threads=Ut;class Zr extends v{create(e,n){return this._client.post("/completions",{body:e,...n,stream:e.stream??!1})}}class zr extends v{retrieve(e,n,s){const{container_id:r}=n;return this._client.get(_`/containers/${r}/files/${e}/content`,{...s,headers:y([{Accept:"application/binary"},s?.headers]),__binaryResponse:!0})}}let Sn=class extends v{constructor(){super(...arguments),this.content=new zr(this._client)}create(e,n,s){return this._client.post(_`/containers/${e}/files`,we({body:n,...s},this._client))}retrieve(e,n,s){const{container_id:r}=n;return this._client.get(_`/containers/${r}/files/${e}`,s)}list(e,n={},s){return this._client.getAPIList(_`/containers/${e}/files`,E,{query:n,...s})}delete(e,n,s){const{container_id:r}=n;return this._client.delete(_`/containers/${r}/files/${e}`,{...s,headers:y([{Accept:"*/*"},s?.headers])})}};Sn.Content=zr;class Cn extends v{constructor(){super(...arguments),this.files=new Sn(this._client)}create(e,n){return this._client.post("/containers",{body:e,...n})}retrieve(e,n){return this._client.get(_`/containers/${e}`,n)}list(e={},n){return this._client.getAPIList("/containers",E,{query:e,...n})}delete(e,n){return this._client.delete(_`/containers/${e}`,{...n,headers:y([{Accept:"*/*"},n?.headers])})}}Cn.Files=Sn;class Hr extends v{create(e,n,s){const{include:r,...a}=n;return this._client.post(_`/conversations/${e}/items`,{query:{include:r},body:a,...s})}retrieve(e,n,s){const{conversation_id:r,...a}=n;return this._client.get(_`/conversations/${r}/items/${e}`,{query:a,...s})}list(e,n={},s){return this._client.getAPIList(_`/conversations/${e}/items`,gt,{query:n,...s})}delete(e,n,s){const{conversation_id:r}=n;return this._client.delete(_`/conversations/${r}/items/${e}`,s)}}class An extends v{constructor(){super(...arguments),this.items=new Hr(this._client)}create(e={},n){return this._client.post("/conversations",{body:e,...n})}retrieve(e,n){return this._client.get(_`/conversations/${e}`,n)}update(e,n,s){return this._client.post(_`/conversations/${e}`,{body:n,...s})}delete(e,n){return this._client.delete(_`/conversations/${e}`,n)}}An.Items=Hr;class Vr extends v{create(e,n){const s=!!e.encoding_format;let r=s?e.encoding_format:"base64";s&&B(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:r},...n});return s?a:(B(this._client).debug("embeddings/decoding base64 embeddings from base64"),a._thenUnwrap(i=>(i&&i.data&&i.data.forEach(o=>{const l=o.embedding;o.embedding=Zi(l)}),i)))}}class Xr extends v{retrieve(e,n,s){const{eval_id:r,run_id:a}=n;return this._client.get(_`/evals/${r}/runs/${a}/output_items/${e}`,s)}list(e,n,s){const{eval_id:r,...a}=n;return this._client.getAPIList(_`/evals/${r}/runs/${e}/output_items`,E,{query:a,...s})}}class Rn extends v{constructor(){super(...arguments),this.outputItems=new Xr(this._client)}create(e,n,s){return this._client.post(_`/evals/${e}/runs`,{body:n,...s})}retrieve(e,n,s){const{eval_id:r}=n;return this._client.get(_`/evals/${r}/runs/${e}`,s)}list(e,n={},s){return this._client.getAPIList(_`/evals/${e}/runs`,E,{query:n,...s})}delete(e,n,s){const{eval_id:r}=n;return this._client.delete(_`/evals/${r}/runs/${e}`,s)}cancel(e,n,s){const{eval_id:r}=n;return this._client.post(_`/evals/${r}/runs/${e}`,s)}}Rn.OutputItems=Xr;class $n extends v{constructor(){super(...arguments),this.runs=new Rn(this._client)}create(e,n){return this._client.post("/evals",{body:e,...n})}retrieve(e,n){return this._client.get(_`/evals/${e}`,n)}update(e,n,s){return this._client.post(_`/evals/${e}`,{body:n,...s})}list(e={},n){return this._client.getAPIList("/evals",E,{query:e,...n})}delete(e,n){return this._client.delete(_`/evals/${e}`,n)}}$n.Runs=Rn;let Gr=class extends v{create(e,n){return this._client.post("/files",we({body:e,...n},this._client))}retrieve(e,n){return this._client.get(_`/files/${e}`,n)}list(e={},n){return this._client.getAPIList("/files",E,{query:e,...n})}delete(e,n){return this._client.delete(_`/files/${e}`,n)}content(e,n){return this._client.get(_`/files/${e}/content`,{...n,headers:y([{Accept:"application/binary"},n?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:n=5e3,maxWait:s=1800*1e3}={}){const r=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(e);for(;!i.status||!r.has(i.status);)if(await Ke(n),i=await this.retrieve(e),Date.now()-a>s)throw new $t({message:`Giving up on waiting for file ${e} to finish processing after ${s} milliseconds.`});return i}};class Qr extends v{}let Yr=class extends v{run(e,n){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...n})}validate(e,n){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...n})}};class Pn extends v{constructor(){super(...arguments),this.graders=new Yr(this._client)}}Pn.Graders=Yr;class ea extends v{create(e,n,s){return this._client.getAPIList(_`/fine_tuning/checkpoints/${e}/permissions`,Mt,{body:n,method:"post",...s})}retrieve(e,n={},s){return this._client.get(_`/fine_tuning/checkpoints/${e}/permissions`,{query:n,...s})}delete(e,n,s){const{fine_tuned_model_checkpoint:r}=n;return this._client.delete(_`/fine_tuning/checkpoints/${r}/permissions/${e}`,s)}}let En=class extends v{constructor(){super(...arguments),this.permissions=new ea(this._client)}};En.Permissions=ea;class ta extends v{list(e,n={},s){return this._client.getAPIList(_`/fine_tuning/jobs/${e}/checkpoints`,E,{query:n,...s})}}class Mn extends v{constructor(){super(...arguments),this.checkpoints=new ta(this._client)}create(e,n){return this._client.post("/fine_tuning/jobs",{body:e,...n})}retrieve(e,n){return this._client.get(_`/fine_tuning/jobs/${e}`,n)}list(e={},n){return this._client.getAPIList("/fine_tuning/jobs",E,{query:e,...n})}cancel(e,n){return this._client.post(_`/fine_tuning/jobs/${e}/cancel`,n)}listEvents(e,n={},s){return this._client.getAPIList(_`/fine_tuning/jobs/${e}/events`,E,{query:n,...s})}pause(e,n){return this._client.post(_`/fine_tuning/jobs/${e}/pause`,n)}resume(e,n){return this._client.post(_`/fine_tuning/jobs/${e}/resume`,n)}}Mn.Checkpoints=ta;class Ae extends v{constructor(){super(...arguments),this.methods=new Qr(this._client),this.jobs=new Mn(this._client),this.checkpoints=new En(this._client),this.alpha=new Pn(this._client)}}Ae.Methods=Qr;Ae.Jobs=Mn;Ae.Checkpoints=En;Ae.Alpha=Pn;class na extends v{}class Nn extends v{constructor(){super(...arguments),this.graderModels=new na(this._client)}}Nn.GraderModels=na;class sa extends v{createVariation(e,n){return this._client.post("/images/variations",we({body:e,...n},this._client))}edit(e,n){return this._client.post("/images/edits",we({body:e,...n,stream:e.stream??!1},this._client))}generate(e,n){return this._client.post("/images/generations",{body:e,...n,stream:e.stream??!1})}}class ra extends v{retrieve(e,n){return this._client.get(_`/models/${e}`,n)}list(e){return this._client.getAPIList("/models",Mt,e)}delete(e,n){return this._client.delete(_`/models/${e}`,n)}}class aa extends v{create(e,n){return this._client.post("/moderations",{body:e,...n})}}class ia extends v{accept(e,n,s){return this._client.post(_`/realtime/calls/${e}/accept`,{body:n,...s,headers:y([{Accept:"*/*"},s?.headers])})}hangup(e,n){return this._client.post(_`/realtime/calls/${e}/hangup`,{...n,headers:y([{Accept:"*/*"},n?.headers])})}refer(e,n,s){return this._client.post(_`/realtime/calls/${e}/refer`,{body:n,...s,headers:y([{Accept:"*/*"},s?.headers])})}reject(e,n={},s){return this._client.post(_`/realtime/calls/${e}/reject`,{body:n,...s,headers:y([{Accept:"*/*"},s?.headers])})}}class oa extends v{create(e,n){return this._client.post("/realtime/client_secrets",{body:e,...n})}}class Lt extends v{constructor(){super(...arguments),this.clientSecrets=new oa(this._client),this.calls=new ia(this._client)}}Lt.ClientSecrets=oa;Lt.Calls=ia;function Hi(t,e){return!e||!Xi(e)?{...t,output_parsed:null,output:t.output.map(n=>n.type==="function_call"?{...n,parsed_arguments:null}:n.type==="message"?{...n,content:n.content.map(s=>({...s,parsed:null}))}:n)}:ua(t,e)}function ua(t,e){const n=t.output.map(r=>{if(r.type==="function_call")return{...r,parsed_arguments:Yi(e,r)};if(r.type==="message"){const a=r.content.map(i=>i.type==="output_text"?{...i,parsed:Vi(e,i.text)}:i);return{...r,content:a}}return r}),s=Object.assign({},t,{output:n});return Object.getOwnPropertyDescriptor(t,"output_text")||dn(s),Object.defineProperty(s,"output_parsed",{enumerable:!0,get(){for(const r of s.output)if(r.type==="message"){for(const a of r.content)if(a.type==="output_text"&&a.parsed!==null)return a.parsed}return null}}),s}function Vi(t,e){return t.text?.format?.type!=="json_schema"?null:"$parseRaw"in t.text?.format?(t.text?.format).$parseRaw(e):JSON.parse(e)}function Xi(t){return!!bn(t.text?.format)}function Gi(t){return t?.$brand==="auto-parseable-tool"}function Qi(t,e){return t.find(n=>n.type==="function"&&n.name===e)}function Yi(t,e){const n=Qi(t.tools??[],e.name);return{...e,...e,parsed_arguments:Gi(n)?n.$parseRaw(e.arguments):n?.strict?JSON.parse(e.arguments):null}}function dn(t){const e=[];for(const n of t.output)if(n.type==="message")for(const s of n.content)s.type==="output_text"&&e.push(s.text);t.output_text=e.join("")}var xe,st,de,rt,xs,Os,Is,ks;class jn extends xn{constructor(e){super(),xe.add(this),st.set(this,void 0),de.set(this,void 0),rt.set(this,void 0),O(this,st,e)}static createResponse(e,n,s){const r=new jn(n);return r._run(()=>r._createOrRetrieveResponse(e,n,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createOrRetrieveResponse(e,n,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),c(this,xe,"m",xs).call(this);let a,i=null;"response_id"in n?(a=await e.responses.retrieve(n.response_id,{stream:!0},{...s,signal:this.controller.signal,stream:!0}),i=n.starting_after??null):a=await e.responses.create({...n,stream:!0},{...s,signal:this.controller.signal}),this._connected();for await(const o of a)c(this,xe,"m",Os).call(this,o,i);if(a.controller.signal?.aborted)throw new Y;return c(this,xe,"m",Is).call(this)}[(st=new WeakMap,de=new WeakMap,rt=new WeakMap,xe=new WeakSet,xs=function(){this.ended||O(this,de,void 0)},Os=function(n,s){if(this.ended)return;const r=(i,o)=>{(s==null||o.sequence_number>s)&&this._emit(i,o)},a=c(this,xe,"m",ks).call(this,n);switch(r("event",n),n.type){case"response.output_text.delta":{const i=a.output[n.output_index];if(!i)throw new x(`missing output at index ${n.output_index}`);if(i.type==="message"){const o=i.content[n.content_index];if(!o)throw new x(`missing content at index ${n.content_index}`);if(o.type!=="output_text")throw new x(`expected content to be 'output_text', got ${o.type}`);r("response.output_text.delta",{...n,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const i=a.output[n.output_index];if(!i)throw new x(`missing output at index ${n.output_index}`);i.type==="function_call"&&r("response.function_call_arguments.delta",{...n,snapshot:i.arguments});break}default:r(n.type,n);break}},Is=function(){if(this.ended)throw new x("stream has ended, this shouldn't happen");const n=c(this,de,"f");if(!n)throw new x("request ended without sending any events");O(this,de,void 0);const s=eo(n,c(this,st,"f"));return O(this,rt,s),s},ks=function(n){let s=c(this,de,"f");if(!s){if(n.type!=="response.created")throw new x(`When snapshot hasn't been set yet, expected 'response.created' event, got ${n.type}`);return s=O(this,de,n.response),s}switch(n.type){case"response.output_item.added":{s.output.push(n.item);break}case"response.content_part.added":{const r=s.output[n.output_index];if(!r)throw new x(`missing output at index ${n.output_index}`);const a=r.type,i=n.part;a==="message"&&i.type!=="reasoning_text"?r.content.push(i):a==="reasoning"&&i.type==="reasoning_text"&&(r.content||(r.content=[]),r.content.push(i));break}case"response.output_text.delta":{const r=s.output[n.output_index];if(!r)throw new x(`missing output at index ${n.output_index}`);if(r.type==="message"){const a=r.content[n.content_index];if(!a)throw new x(`missing content at index ${n.content_index}`);if(a.type!=="output_text")throw new x(`expected content to be 'output_text', got ${a.type}`);a.text+=n.delta}break}case"response.function_call_arguments.delta":{const r=s.output[n.output_index];if(!r)throw new x(`missing output at index ${n.output_index}`);r.type==="function_call"&&(r.arguments+=n.delta);break}case"response.reasoning_text.delta":{const r=s.output[n.output_index];if(!r)throw new x(`missing output at index ${n.output_index}`);if(r.type==="reasoning"){const a=r.content?.[n.content_index];if(!a)throw new x(`missing content at index ${n.content_index}`);if(a.type!=="reasoning_text")throw new x(`expected content to be 'reasoning_text', got ${a.type}`);a.text+=n.delta}break}case"response.completed":{O(this,de,n.response);break}}return s},Symbol.asyncIterator)](){const e=[],n=[];let s=!1;return this.on("event",r=>{const a=n.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of n)r.resolve(void 0);n.length=0}),this.on("abort",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),this.on("error",r=>{s=!0;for(const a of n)a.reject(r);n.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((a,i)=>n.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=c(this,rt,"f");if(!e)throw new x("stream ended without producing a ChatCompletion");return e}}function eo(t,e){return Hi(t,e)}class la extends v{list(e,n={},s){return this._client.getAPIList(_`/responses/${e}/input_items`,E,{query:n,...s})}}class ca extends v{count(e={},n){return this._client.post("/responses/input_tokens",{body:e,...n})}}class Dt extends v{constructor(){super(...arguments),this.inputItems=new la(this._client),this.inputTokens=new ca(this._client)}create(e,n){return this._client.post("/responses",{body:e,...n,stream:e.stream??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&dn(s),s))}retrieve(e,n={},s){return this._client.get(_`/responses/${e}`,{query:n,...s,stream:n?.stream??!1})._thenUnwrap(r=>("object"in r&&r.object==="response"&&dn(r),r))}delete(e,n){return this._client.delete(_`/responses/${e}`,{...n,headers:y([{Accept:"*/*"},n?.headers])})}parse(e,n){return this._client.responses.create(e,n)._thenUnwrap(s=>ua(s,e))}stream(e,n){return jn.createResponse(this._client,e,n)}cancel(e,n){return this._client.post(_`/responses/${e}/cancel`,n)}compact(e={},n){return this._client.post("/responses/compact",{body:e,...n})}}Dt.InputItems=la;Dt.InputTokens=ca;class da extends v{create(e,n,s){return this._client.post(_`/uploads/${e}/parts`,we({body:n,...s},this._client))}}class Un extends v{constructor(){super(...arguments),this.parts=new da(this._client)}create(e,n){return this._client.post("/uploads",{body:e,...n})}cancel(e,n){return this._client.post(_`/uploads/${e}/cancel`,n)}complete(e,n,s){return this._client.post(_`/uploads/${e}/complete`,{body:n,...s})}}Un.Parts=da;const to=async t=>{const e=await Promise.allSettled(t),n=e.filter(r=>r.status==="rejected");if(n.length){for(const r of n)console.error(r.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const s=[];for(const r of e)r.status==="fulfilled"&&s.push(r.value);return s};class pa extends v{create(e,n,s){return this._client.post(_`/vector_stores/${e}/file_batches`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,n,s){const{vector_store_id:r}=n;return this._client.get(_`/vector_stores/${r}/file_batches/${e}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}cancel(e,n,s){const{vector_store_id:r}=n;return this._client.post(_`/vector_stores/${r}/file_batches/${e}/cancel`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,n,s){const r=await this.create(e,n);return await this.poll(e,r.id,s)}listFiles(e,n,s){const{vector_store_id:r,...a}=n;return this._client.getAPIList(_`/vector_stores/${r}/file_batches/${e}/files`,E,{query:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async poll(e,n,s){const r=y([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:a,response:i}=await this.retrieve(n,{vector_store_id:e},{...s,headers:r}).withResponse();switch(a.status){case"in_progress":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const l=i.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(o=u)}}await Ke(o);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:n,fileIds:s=[]},r){if(n==null||n.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=r?.maxConcurrency??5,i=Math.min(a,n.length),o=this._client,l=n.values(),u=[...s];async function m(f){for(let d of f){const b=await o.files.create({file:d,purpose:"assistants"},r);u.push(b.id)}}const p=Array(i).fill(l).map(m);return await to(p),await this.createAndPoll(e,{file_ids:u})}}class fa extends v{create(e,n,s){return this._client.post(_`/vector_stores/${e}/files`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}retrieve(e,n,s){const{vector_store_id:r}=n;return this._client.get(_`/vector_stores/${r}/files/${e}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}update(e,n,s){const{vector_store_id:r,...a}=n;return this._client.post(_`/vector_stores/${r}/files/${e}`,{body:a,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e,n={},s){return this._client.getAPIList(_`/vector_stores/${e}/files`,E,{query:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}delete(e,n,s){const{vector_store_id:r}=n;return this._client.delete(_`/vector_stores/${r}/files/${e}`,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}async createAndPoll(e,n,s){const r=await this.create(e,n,s);return await this.poll(e,r.id,s)}async poll(e,n,s){const r=y([s?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":s?.pollIntervalMs?.toString()??void 0}]);for(;;){const a=await this.retrieve(n,{vector_store_id:e},{...s,headers:r}).withResponse(),i=a.data;switch(i.status){case"in_progress":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const l=a.response.headers.get("openai-poll-after-ms");if(l){const u=parseInt(l);isNaN(u)||(o=u)}}await Ke(o);break;case"failed":case"completed":return i}}}async upload(e,n,s){const r=await this._client.files.create({file:n,purpose:"assistants"},s);return this.create(e,{file_id:r.id},s)}async uploadAndPoll(e,n,s){const r=await this.upload(e,n,s);return await this.poll(e,r.id,s)}content(e,n,s){const{vector_store_id:r}=n;return this._client.getAPIList(_`/vector_stores/${r}/files/${e}/content`,Mt,{...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}class Ft extends v{constructor(){super(...arguments),this.files=new fa(this._client),this.fileBatches=new pa(this._client)}create(e,n){return this._client.post("/vector_stores",{body:e,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,n){return this._client.get(_`/vector_stores/${e}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,n,s){return this._client.post(_`/vector_stores/${e}`,{body:n,...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}list(e={},n){return this._client.getAPIList("/vector_stores",E,{query:e,...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,n){return this._client.delete(_`/vector_stores/${e}`,{...n,headers:y([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}search(e,n,s){return this._client.getAPIList(_`/vector_stores/${e}/search`,Mt,{body:n,method:"post",...s,headers:y([{"OpenAI-Beta":"assistants=v2"},s?.headers])})}}Ft.Files=fa;Ft.FileBatches=pa;class ha extends v{create(e,n){return this._client.post("/videos",cs({body:e,...n},this._client))}retrieve(e,n){return this._client.get(_`/videos/${e}`,n)}list(e={},n){return this._client.getAPIList("/videos",gt,{query:e,...n})}delete(e,n){return this._client.delete(_`/videos/${e}`,n)}downloadContent(e,n={},s){return this._client.get(_`/videos/${e}/content`,{query:n,...s,headers:y([{Accept:"application/binary"},s?.headers]),__binaryResponse:!0})}remix(e,n,s){return this._client.post(_`/videos/${e}/remix`,cs({body:n,...s},this._client))}}var ke,ma,ft;class ga extends v{constructor(){super(...arguments),ke.add(this)}async unwrap(e,n,s=this._client.webhookSecret,r=300){return await this.verifySignature(e,n,s,r),JSON.parse(e)}async verifySignature(e,n,s=this._client.webhookSecret,r=300){if(typeof crypto>"u"||typeof crypto.subtle.importKey!="function"||typeof crypto.subtle.verify!="function")throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");c(this,ke,"m",ma).call(this,s);const a=y([n]).values,i=c(this,ke,"m",ft).call(this,a,"webhook-signature"),o=c(this,ke,"m",ft).call(this,a,"webhook-timestamp"),l=c(this,ke,"m",ft).call(this,a,"webhook-id"),u=parseInt(o,10);if(isNaN(u))throw new Pe("Invalid webhook timestamp format");const m=Math.floor(Date.now()/1e3);if(m-u>r)throw new Pe("Webhook timestamp is too old");if(u>m+r)throw new Pe("Webhook timestamp is too new");const p=i.split(" ").map(w=>w.startsWith("v1,")?w.substring(3):w),f=s.startsWith("whsec_")?Buffer.from(s.replace("whsec_",""),"base64"):Buffer.from(s,"utf-8"),d=l?`${l}.${o}.${e}`:`${o}.${e}`,b=await crypto.subtle.importKey("raw",f,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const w of p)try{const $=Buffer.from(w,"base64");if(await crypto.subtle.verify("HMAC",b,$,new TextEncoder().encode(d)))return}catch{continue}throw new Pe("The given webhook signature does not match the expected signature")}}ke=new WeakSet,ma=function(e){if(typeof e!="string"||e.length===0)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},ft=function(e,n){if(!e)throw new Error("Headers are required");const s=e.get(n);if(s==null)throw new Error(`Missing required header: ${n}`);return s};var pn,Ln,ht,_a;class k{constructor({baseURL:e=ve("OPENAI_BASE_URL"),apiKey:n=ve("OPENAI_API_KEY"),organization:s=ve("OPENAI_ORG_ID")??null,project:r=ve("OPENAI_PROJECT_ID")??null,webhookSecret:a=ve("OPENAI_WEBHOOK_SECRET")??null,...i}={}){if(pn.add(this),ht.set(this,void 0),this.completions=new Zr(this),this.chat=new kn(this),this.embeddings=new Vr(this),this.files=new Gr(this),this.images=new sa(this),this.audio=new ze(this),this.moderations=new aa(this),this.models=new ra(this),this.fineTuning=new Ae(this),this.graders=new Nn(this),this.vectorStores=new Ft(this),this.webhooks=new ga(this),this.beta=new Ce(this),this.batches=new Lr(this),this.uploads=new Un(this),this.responses=new Dt(this),this.realtime=new Lt(this),this.conversations=new An(this),this.evals=new $n(this),this.containers=new Cn(this),this.videos=new ha(this),n===void 0)throw new x("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const o={apiKey:n,organization:s,project:r,webhookSecret:a,...i,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&ti())throw new x(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);this.baseURL=o.baseURL,this.timeout=o.timeout??Ln.DEFAULT_TIMEOUT,this.logger=o.logger??console;const l="warn";this.logLevel=l,this.logLevel=us(o.logLevel,"ClientOptions.logLevel",this)??us(ve("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??l,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??ii(),O(this,ht,ui),this._options=o,this.apiKey=typeof n=="string"?n:"Missing Key",this.organization=s,this.project=r,this.webhookSecret=a}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:n}){}async authHeaders(e){return y([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return hi(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${Oe}`}defaultIdempotencyKey(){return`stainless-node-retry-${Fs()}`}makeStatusError(e,n,s,r){return q.generate(e,n,s,r)}async _callApiKey(){const e=this._options.apiKey;if(typeof e!="function")return!1;let n;try{n=await e()}catch(s){throw s instanceof x?s:new x(`Failed to get token from 'apiKey' function: ${s.message}`,{cause:s})}if(typeof n!="string"||!n)throw new x(`Expected 'apiKey' function argument to return a string but it returned ${n}`);return this.apiKey=n,!0}buildURL(e,n,s){const r=!c(this,pn,"m",_a).call(this)&&s||this.baseURL,a=Xa(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return Ga(i)||(n={...i,...n}),typeof n=="object"&&n&&!Array.isArray(n)&&(a.search=this.stringifyQuery(n)),a.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:n,options:s}){}get(e,n){return this.methodRequest("get",e,n)}post(e,n){return this.methodRequest("post",e,n)}patch(e,n){return this.methodRequest("patch",e,n)}put(e,n){return this.methodRequest("put",e,n)}delete(e,n){return this.methodRequest("delete",e,n)}methodRequest(e,n,s){return this.request(Promise.resolve(s).then(r=>({method:e,path:n,...r})))}request(e,n=null){return new Et(this,this.makeRequest(e,n,void 0))}async makeRequest(e,n,s){const r=await e,a=r.maxRetries??this.maxRetries;n==null&&(n=a),await this.prepareOptions(r);const{req:i,url:o,timeout:l}=await this.buildRequest(r,{retryCount:a-n});await this.prepareRequest(i,{url:o,options:r});const u="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),m=s===void 0?"":`, retryOf: ${s}`,p=Date.now();if(B(this).debug(`[${u}] sending request`,fe({retryOfRequestLogID:s,method:r.method,url:o,options:r,headers:i.headers})),r.signal?.aborted)throw new Y;const f=new AbortController,d=await this.fetchWithTimeout(o,i,l,f).catch(Yt),b=Date.now();if(d instanceof globalThis.Error){const h=`retrying, ${n} attempts remaining`;if(r.signal?.aborted)throw new Y;const g=Qt(d)||/timed? ?out/i.test(String(d)+("cause"in d?String(d.cause):""));if(n)return B(this).info(`[${u}] connection ${g?"timed out":"failed"} - ${h}`),B(this).debug(`[${u}] connection ${g?"timed out":"failed"} (${h})`,fe({retryOfRequestLogID:s,url:o,durationMs:b-p,message:d.message})),this.retryRequest(r,n,s??u);throw B(this).info(`[${u}] connection ${g?"timed out":"failed"} - error; no more retries left`),B(this).debug(`[${u}] connection ${g?"timed out":"failed"} (error; no more retries left)`,fe({retryOfRequestLogID:s,url:o,durationMs:b-p,message:d.message})),g?new $t:new Rt({cause:d})}const w=[...d.headers.entries()].filter(([h])=>h==="x-request-id").map(([h,g])=>", "+h+": "+JSON.stringify(g)).join(""),$=`[${u}${m}${w}] ${i.method} ${o} ${d.ok?"succeeded":"failed"} with status ${d.status} in ${b-p}ms`;if(!d.ok){const h=await this.shouldRetry(d);if(n&&h){const R=`retrying, ${n} attempts remaining`;return await oi(d.body),B(this).info(`${$} - ${R}`),B(this).debug(`[${u}] response error (${R})`,fe({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,durationMs:b-p})),this.retryRequest(r,n,s??u,d.headers)}const g=h?"error; no more retries left":"error; not retryable";B(this).info(`${$} - ${g}`);const T=await d.text().catch(R=>Yt(R).message),C=ei(T),Z=C?void 0:T;throw B(this).debug(`[${u}] response error (${g})`,fe({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,message:Z,durationMs:Date.now()-p})),this.makeStatusError(d.status,C,Z,d.headers)}return B(this).info($),B(this).debug(`[${u}] response start`,fe({retryOfRequestLogID:s,url:d.url,status:d.status,headers:d.headers,durationMs:b-p})),{response:d,options:r,controller:f,requestLogID:u,retryOfRequestLogID:s,startTime:p}}getAPIList(e,n,s){return this.requestAPIList(n,{method:"get",path:e,...s})}requestAPIList(e,n){const s=this.makeRequest(n,null,void 0);return new Oi(this,s,e)}async fetchWithTimeout(e,n,s,r){const{signal:a,method:i,...o}=n||{};a&&a.addEventListener("abort",()=>r.abort());const l=setTimeout(()=>r.abort(),s),u=globalThis.ReadableStream&&o.body instanceof globalThis.ReadableStream||typeof o.body=="object"&&o.body!==null&&Symbol.asyncIterator in o.body,m={signal:r.signal,...u?{duplex:"half"}:{},method:"GET",...o};i&&(m.method=i.toUpperCase());try{return await this.fetch.call(void 0,e,m)}finally{clearTimeout(l)}}async shouldRetry(e){const n=e.headers.get("x-should-retry");return n==="true"?!0:n==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,n,s,r){let a;const i=r?.get("retry-after-ms");if(i){const l=parseFloat(i);Number.isNaN(l)||(a=l)}const o=r?.get("retry-after");if(o&&!a){const l=parseFloat(o);Number.isNaN(l)?a=Date.parse(o)-Date.now():a=l*1e3}if(!(a&&0<=a&&a<60*1e3)){const l=e.maxRetries??this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(n,l)}return await Ke(a),this.makeRequest(e,n-1,s)}calculateDefaultRetryTimeoutMillis(e,n){const a=n-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}async buildRequest(e,{retryCount:n=0}={}){const s={...e},{method:r,path:a,query:i,defaultBaseURL:o}=s,l=this.buildURL(a,i,o);"timeout"in s&&Ya("timeout",s.timeout),s.timeout=s.timeout??this.timeout;const{bodyHeaders:u,body:m}=this.buildBody({options:s}),p=await this.buildHeaders({options:e,method:r,bodyHeaders:u,retryCount:n});return{req:{method:r,headers:p,...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&m instanceof globalThis.ReadableStream&&{duplex:"half"},...m&&{body:m},...this.fetchOptions??{},...s.fetchOptions??{}},url:l,timeout:s.timeout}}async buildHeaders({options:e,method:n,bodyHeaders:s,retryCount:r}){let a={};this.idempotencyHeader&&n!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);const i=y([a,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...ai(),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,s,e.headers]);return this.validateHeaders(i),i.values}buildBody({options:{body:e,headers:n}}){if(!e)return{bodyHeaders:void 0,body:void 0};const s=y([n]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||typeof e=="string"&&s.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:typeof e=="object"&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&typeof e.next=="function")?{bodyHeaders:void 0,body:Ys(e)}:c(this,ht,"f").call(this,{body:e,headers:s})}}Ln=k,ht=new WeakMap,pn=new WeakSet,_a=function(){return this.baseURL!=="https://api.openai.com/v1"};k.OpenAI=Ln;k.DEFAULT_TIMEOUT=6e5;k.OpenAIError=x;k.APIError=q;k.APIConnectionError=Rt;k.APIConnectionTimeoutError=$t;k.APIUserAbortError=Y;k.NotFoundError=Js;k.ConflictError=Ks;k.RateLimitError=zs;k.BadRequestError=Bs;k.AuthenticationError=Ws;k.InternalServerError=Hs;k.PermissionDeniedError=qs;k.UnprocessableEntityError=Zs;k.InvalidWebhookSignatureError=Pe;k.toFile=Ci;k.Completions=Zr;k.Chat=kn;k.Embeddings=Vr;k.Files=Gr;k.Images=sa;k.Audio=ze;k.Moderations=aa;k.Models=ra;k.FineTuning=Ae;k.Graders=Nn;k.VectorStores=Ft;k.Webhooks=ga;k.Beta=Ce;k.Batches=Lr;k.Uploads=Un;k.Responses=Dt;k.Realtime=Lt;k.Conversations=An;k.Evals=$n;k.Containers=Cn;k.Videos=ha;function Dn(t){if(!t||typeof t!="object")return t;let e;return t.constructor.name===$t.name&&"message"in t&&typeof t.message=="string"?(e=new Error(t.message),e.name="TimeoutError"):t.constructor.name===Y.name&&"message"in t&&typeof t.message=="string"?(e=new Error(t.message),e.name="AbortError"):"status"in t&&t.status===400&&"message"in t&&typeof t.message=="string"&&t.message.includes("tool_calls")?e=Ge(t,"INVALID_TOOL_RESULTS"):"status"in t&&t.status===401?e=Ge(t,"MODEL_AUTHENTICATION"):"status"in t&&t.status===429?e=Ge(t,"MODEL_RATE_LIMIT"):"status"in t&&t.status===404?e=Ge(t,"MODEL_NOT_FOUND"):e=t,e}const ye=t=>t();function He(t){return t?!!(/^o\d/.test(t??"")||t.startsWith("gpt-5")&&!t.startsWith("gpt-5-chat")):!1}function no(t){return t.role!=="system"&&t.role!=="developer"&&t.role!=="assistant"&&t.role!=="user"&&t.role!=="function"&&t.role!=="tool"&&console.warn(`Unknown message role: ${t.role}`),t.role}function It(t){const e=t.metadata?.filename??t.metadata?.name??t.metadata?.title;if(!e)throw new Error("a filename or name or title is needed via meta-data for OpenAI when working with multimodal blocks");return e}function Ve(t){const e=t._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!Es.isInstance(t))throw new Error("Invalid generic chat message");return no(t);default:throw new Error(`Unknown message type: ${e}`)}}function so(t){return t.includes("gpt-5.2-pro")}function ro(t){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:s,azureOpenAIBasePath:r,baseURL:a,azureADTokenProvider:i,azureOpenAIEndpoint:o}=t;if((s||i)&&r&&e)return`${r}/${e}`;if((s||i)&&o&&e)return`${o}/openai/deployments/${e}`;if(s||i){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${e}`}return a}function Ts(t){return typeof Headers<"u"&&t!==null&&typeof t=="object"&&Object.prototype.toString.call(t)==="[object Headers]"}function ao(t){const e=ye(()=>{if(Ts(t))return t;if(Array.isArray(t))return new Headers(t);if(typeof t=="object"&&t!==null&&"values"in t&&Ts(t.values))return t.values;if(typeof t=="object"&&t!==null){const n=Object.entries(t).filter(([,s])=>typeof s=="string").map(([s,r])=>[s,r]);return new Headers(n)}return new Headers});return Object.fromEntries(e.entries())}function io(){let t=Ra();return(t==="node"||t==="deno")&&(t=`(${t}/${process.version}; browser; ${process.arch})`),t}function oo(t,e=!1,n="1.0.0"){const s=ao(t),r=io(),a=`langchainjs${e?"-azure":""}-openai`;return{...s,"User-Agent":s["User-Agent"]?`${a}/${n} (${r})${s["User-Agent"]}`:`${a}/${n} (${r})`}}function uo(t,e){let n;return Wa(t)?n=qa(t):n=t,e?.strict!==void 0&&(n.function.strict=e.strict),n}function lo(t){return t.anyOf!==void 0&&Array.isArray(t.anyOf)}function co(t){const e=["namespace functions {",""];for(const n of t)n.description&&e.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(e.push(`type ${n.name} = (_: {`),e.push(ya(n.parameters,0)),e.push("}) => any;")):e.push(`type ${n.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function ya(t,e){const n=[];for(const[s,r]of Object.entries(t.properties??{}))r.description&&e<2&&n.push(`// ${r.description}`),t.required?.includes(s)?n.push(`${s}: ${kt(r,e)},`):n.push(`${s}?: ${kt(r,e)},`);return n.map(s=>" ".repeat(e)+s).join(`
`)}function kt(t,e){if(lo(t))return t.anyOf.map(n=>kt(n,e)).join(" | ");switch(t.type){case"string":return t.enum?t.enum.map(n=>`"${n}"`).join(" | "):"string";case"number":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"integer":return t.enum?t.enum.map(n=>`${n}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",ya(t,e+2),"}"].join(`
`);case"array":return t.items?`${kt(t.items,e)}[]`:"any[]";default:return""}}function wa(t){if(t)return t==="any"||t==="required"?"required":t==="auto"?"auto":t==="none"?"none":typeof t=="string"?{type:"function",function:{name:t}}:t}function Fn(t){return"type"in t&&t.type!=="function"}function po(t){return typeof t=="object"&&t!==null&&"extras"in t&&typeof t.extras=="object"&&t.extras!==null&&"providerToolDefinition"in t.extras&&typeof t.extras.providerToolDefinition=="object"&&t.extras.providerToolDefinition!==null}function fo(t){return t!=null&&typeof t=="object"&&"type"in t&&t.type!=="function"}function Tt(t){return typeof t=="object"&&t!==null&&"metadata"in t&&typeof t.metadata=="object"&&t.metadata!==null&&"customTool"in t.metadata&&typeof t.metadata.customTool=="object"&&t.metadata.customTool!==null}function ba(t){return"type"in t&&t.type==="custom"&&"custom"in t&&typeof t.custom=="object"&&t.custom!==null}function ho(t){if(t.type==="custom_tool_call")return{...t,type:"tool_call",call_id:t.id,id:t.call_id,name:t.name,isCustomTool:!0,args:{input:t.input}}}function mo(t){if(t.type==="computer_call")return{...t,type:"tool_call",call_id:t.id,id:t.call_id,name:"computer_use",isComputerTool:!0,args:{action:t.action}}}function go(t){return typeof t=="object"&&t!==null&&"type"in t&&t.type==="tool_call"&&"isComputerTool"in t&&t.isComputerTool===!0}function _o(t){return typeof t=="object"&&t!==null&&"type"in t&&t.type==="tool_call"&&"isCustomTool"in t&&t.isCustomTool===!0}function yo(t){const e=()=>{if(t.custom.format){if(t.custom.format.type==="grammar")return{type:"grammar",definition:t.custom.format.grammar.definition,syntax:t.custom.format.grammar.syntax};if(t.custom.format.type==="text")return{type:"text"}}};return{type:"custom",name:t.custom.name,description:t.custom.description,format:e()}}function wo(t){const e=()=>{if(t.format){if(t.format.type==="grammar")return{type:"grammar",grammar:{definition:t.format.definition,syntax:t.format.syntax}};if(t.format.type==="text")return{type:"text"}}};return{type:"custom",custom:{name:t.name,description:t.description,format:e()}}}const bo=Symbol("Let zodToJsonSchema decide on which parser to use"),Ss={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},vo=t=>typeof t=="string"?{...Ss,basePath:["#"],definitions:{},name:t}:{...Ss,basePath:["#"],definitions:{},...t},fn=t=>"_def"in t?t._def:t;function xo(t){if(!t)return!0;for(const e in t)return!1;return!0}const Oo=t=>{const e=vo(t),n=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(e.definitions).map(([s,r])=>[fn(r),{def:fn(r),path:[...e.basePath,e.definitionPath,s],jsonSchema:void 0}]))}};function va(t,e,n,s){s?.errorMessages&&n&&(t.errorMessage={...t.errorMessage,[e]:n})}function A(t,e,n,s,r){t[e]=n,va(t,e,s,r)}function Io(){return{}}function ko(t,e){const n={type:"array"};return t.type?._def?.typeName!==I.ZodAny&&(n.items=S(t.type._def,{...e,currentPath:[...e.currentPath,"items"]})),t.minLength&&A(n,"minItems",t.minLength.value,t.minLength.message,e),t.maxLength&&A(n,"maxItems",t.maxLength.value,t.maxLength.message,e),t.exactLength&&(A(n,"minItems",t.exactLength.value,t.exactLength.message,e),A(n,"maxItems",t.exactLength.value,t.exactLength.message,e)),n}function To(t,e){const n={type:"integer",format:"int64"};if(!t.checks)return n;for(const s of t.checks)switch(s.kind){case"min":e.target==="jsonSchema7"?s.inclusive?A(n,"minimum",s.value,s.message,e):A(n,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(n.exclusiveMinimum=!0),A(n,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?A(n,"maximum",s.value,s.message,e):A(n,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(n.exclusiveMaximum=!0),A(n,"maximum",s.value,s.message,e));break;case"multipleOf":A(n,"multipleOf",s.value,s.message,e);break}return n}function So(){return{type:"boolean"}}function Co(t,e){return S(t.type._def,e)}const Ao=(t,e)=>S(t.innerType._def,e);function xa(t,e,n){const s=n??e.dateStrategy;if(Array.isArray(s))return{anyOf:s.map((r,a)=>xa(t,e,r))};switch(s){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Ro(t,e)}}const Ro=(t,e)=>{const n={type:"integer",format:"unix-time"};if(e.target==="openApi3")return n;for(const s of t.checks)switch(s.kind){case"min":A(n,"minimum",s.value,s.message,e);break;case"max":A(n,"maximum",s.value,s.message,e);break}return n};function $o(t,e){return{...S(t.innerType._def,e),default:t.defaultValue()}}function Po(t,e,n){return e.effectStrategy==="input"?S(t.schema._def,e,n):{}}function Eo(t){return{type:"string",enum:[...t.values]}}const Mo=t=>"type"in t&&t.type==="string"?!1:"allOf"in t;function No(t,e){const n=[S(t.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),S(t.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a);let s=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0;const r=[];return n.forEach(a=>{if(Mo(a))r.push(...a.allOf),a.unevaluatedProperties===void 0&&(s=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){const{additionalProperties:o,...l}=a;i=l}else s=void 0;r.push(i)}}),r.length?{allOf:r,...s}:void 0}function jo(t,e){const n=typeof t.value;return n!=="bigint"&&n!=="number"&&n!=="boolean"&&n!=="string"?{type:Array.isArray(t.value)?"array":"object"}:e.target==="openApi3"?{type:n==="bigint"?"integer":n,enum:[t.value]}:{type:n==="bigint"?"integer":n,const:t.value}}let Xt;const pe={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(Xt===void 0&&(Xt=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Xt),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Oa(t,e){const n={type:"string"};function s(r){return e.patternStrategy==="escape"?Uo(r):r}if(t.checks)for(const r of t.checks)switch(r.kind){case"min":A(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e);break;case"max":A(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"email":switch(e.emailStrategy){case"format:email":te(n,"email",r.message,e);break;case"format:idn-email":te(n,"idn-email",r.message,e);break;case"pattern:zod":ne(n,pe.email,r.message,e);break}break;case"url":te(n,"uri",r.message,e);break;case"uuid":te(n,"uuid",r.message,e);break;case"regex":ne(n,r.regex,r.message,e);break;case"cuid":ne(n,pe.cuid,r.message,e);break;case"cuid2":ne(n,pe.cuid2,r.message,e);break;case"startsWith":ne(n,RegExp(`^${s(r.value)}`),r.message,e);break;case"endsWith":ne(n,RegExp(`${s(r.value)}$`),r.message,e);break;case"datetime":te(n,"date-time",r.message,e);break;case"date":te(n,"date",r.message,e);break;case"time":te(n,"time",r.message,e);break;case"duration":te(n,"duration",r.message,e);break;case"length":A(n,"minLength",typeof n.minLength=="number"?Math.max(n.minLength,r.value):r.value,r.message,e),A(n,"maxLength",typeof n.maxLength=="number"?Math.min(n.maxLength,r.value):r.value,r.message,e);break;case"includes":{ne(n,RegExp(s(r.value)),r.message,e);break}case"ip":{r.version!=="v6"&&te(n,"ipv4",r.message,e),r.version!=="v4"&&te(n,"ipv6",r.message,e);break}case"emoji":ne(n,pe.emoji,r.message,e);break;case"ulid":{ne(n,pe.ulid,r.message,e);break}case"base64":{switch(e.base64Strategy){case"format:binary":{te(n,"binary",r.message,e);break}case"contentEncoding:base64":{A(n,"contentEncoding","base64",r.message,e);break}case"pattern:zod":{ne(n,pe.base64,r.message,e);break}}break}case"nanoid":ne(n,pe.nanoid,r.message,e)}return n}const Uo=t=>Array.from(t).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),te=(t,e,n,s)=>{t.format||t.anyOf?.some(r=>r.format)?(t.anyOf||(t.anyOf=[]),t.format&&(t.anyOf.push({format:t.format,...t.errorMessage&&s.errorMessages&&{errorMessage:{format:t.errorMessage.format}}}),delete t.format,t.errorMessage&&(delete t.errorMessage.format,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.anyOf.push({format:e,...n&&s.errorMessages&&{errorMessage:{format:n}}})):A(t,"format",e,n,s)},ne=(t,e,n,s)=>{t.pattern||t.allOf?.some(r=>r.pattern)?(t.allOf||(t.allOf=[]),t.pattern&&(t.allOf.push({pattern:t.pattern,...t.errorMessage&&s.errorMessages&&{errorMessage:{pattern:t.errorMessage.pattern}}}),delete t.pattern,t.errorMessage&&(delete t.errorMessage.pattern,Object.keys(t.errorMessage).length===0&&delete t.errorMessage)),t.allOf.push({pattern:Cs(e,s),...n&&s.errorMessages&&{errorMessage:{pattern:n}}})):A(t,"pattern",Cs(e,s),n,s)},Cs=(t,e)=>{const n=typeof t=="function"?t():t;if(!e.applyRegexFlags||!n.flags)return n.source;const s={i:n.flags.includes("i"),m:n.flags.includes("m"),s:n.flags.includes("s")},r=s.i?n.source.toLowerCase():n.source;let a="",i=!1,o=!1,l=!1;for(let u=0;u<r.length;u++){if(i){a+=r[u],i=!1;continue}if(s.i){if(o){if(r[u].match(/[a-z]/)){l?(a+=r[u],a+=`${r[u-2]}-${r[u]}`.toUpperCase(),l=!1):r[u+1]==="-"&&r[u+2]?.match(/[a-z]/)?(a+=r[u],l=!0):a+=`${r[u]}${r[u].toUpperCase()}`;continue}}else if(r[u].match(/[a-z]/)){a+=`[${r[u]}${r[u].toUpperCase()}]`;continue}}if(s.m){if(r[u]==="^"){a+=`(^|(?<=[\r
]))`;continue}else if(r[u]==="$"){a+=`($|(?=[\r
]))`;continue}}if(s.s&&r[u]==="."){a+=o?`${r[u]}\r
`:`[${r[u]}\r
]`;continue}a+=r[u],r[u]==="\\"?i=!0:o&&r[u]==="]"?o=!1:!o&&r[u]==="["&&(o=!0)}try{const u=new RegExp(a)}catch{return console.warn(`Could not convert regex pattern at ${e.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return a};function Ia(t,e){if(e.target==="openApi3"&&t.keyType?._def.typeName===I.ZodEnum)return{type:"object",required:t.keyType._def.values,properties:t.keyType._def.values.reduce((s,r)=>({...s,[r]:S(t.valueType._def,{...e,currentPath:[...e.currentPath,"properties",r]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:S(t.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??{}};if(e.target==="openApi3")return n;if(t.keyType?._def.typeName===I.ZodString&&t.keyType._def.checks?.length){const s=Object.entries(Oa(t.keyType._def,e)).reduce((r,[a,i])=>a==="type"?r:{...r,[a]:i},{});return{...n,propertyNames:s}}else if(t.keyType?._def.typeName===I.ZodEnum)return{...n,propertyNames:{enum:t.keyType._def.values}};return n}function Lo(t,e){if(e.mapStrategy==="record")return Ia(t,e);const n=S(t.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},s=S(t.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[n,s],minItems:2,maxItems:2}}}function Do(t){const e=t.values,s=Object.keys(t.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),r=Array.from(new Set(s.map(a=>typeof a)));return{type:r.length===1?r[0]==="string"?"string":"number":["string","number"],enum:s}}function Fo(){return{not:{}}}function Bo(t){return t.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}const St={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Wo(t,e){if(e.target==="openApi3")return As(t,e);const n=t.options instanceof Map?Array.from(t.options.values()):t.options;if(n.every(s=>s._def.typeName in St&&(!s._def.checks||!s._def.checks.length))){const s=n.reduce((r,a)=>{const i=St[a._def.typeName];return i&&!r.includes(i)?[...r,i]:r},[]);return{type:s.length>1?s:s[0]}}else if(n.every(s=>s._def.typeName==="ZodLiteral"&&!s.description)){const s=n.reduce((r,a)=>{const i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...r,i];case"bigint":return[...r,"integer"];case"object":if(a._def.value===null)return[...r,"null"];case"symbol":case"undefined":case"function":default:return r}},[]);if(s.length===n.length){const r=s.filter((a,i,o)=>o.indexOf(a)===i);return{type:r.length>1?r:r[0],enum:n.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(n.every(s=>s._def.typeName==="ZodEnum"))return{type:"string",enum:n.reduce((s,r)=>[...s,...r._def.values.filter(a=>!s.includes(a))],[])};return As(t,e)}const As=(t,e)=>{const n=(t.options instanceof Map?Array.from(t.options.values()):t.options).map((s,r)=>S(s._def,{...e,currentPath:[...e.currentPath,"anyOf",`${r}`]})).filter(s=>!!s&&(!e.strictUnions||typeof s=="object"&&Object.keys(s).length>0));return n.length?{anyOf:n}:void 0};function qo(t,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(t.innerType._def.typeName)&&(!t.innerType._def.checks||!t.innerType._def.checks.length))return e.target==="openApi3"||e.nullableStrategy==="property"?{type:St[t.innerType._def.typeName],nullable:!0}:{type:[St[t.innerType._def.typeName],"null"]};if(e.target==="openApi3"){const s=S(t.innerType._def,{...e,currentPath:[...e.currentPath]});return s&&"$ref"in s?{allOf:[s],nullable:!0}:s&&{...s,nullable:!0}}const n=S(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}function Jo(t,e){const n={type:"number"};if(!t.checks)return n;for(const s of t.checks)switch(s.kind){case"int":n.type="integer",va(n,"type",s.message,e);break;case"min":e.target==="jsonSchema7"?s.inclusive?A(n,"minimum",s.value,s.message,e):A(n,"exclusiveMinimum",s.value,s.message,e):(s.inclusive||(n.exclusiveMinimum=!0),A(n,"minimum",s.value,s.message,e));break;case"max":e.target==="jsonSchema7"?s.inclusive?A(n,"maximum",s.value,s.message,e):A(n,"exclusiveMaximum",s.value,s.message,e):(s.inclusive||(n.exclusiveMaximum=!0),A(n,"maximum",s.value,s.message,e));break;case"multipleOf":A(n,"multipleOf",s.value,s.message,e);break}return n}function Ko(t,e){return e.removeAdditionalStrategy==="strict"?t.catchall._def.typeName==="ZodNever"?t.unknownKeys!=="strict":S(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":S(t.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]})??!0}function Zo(t,e){const n={type:"object",...Object.entries(t.shape()).reduce((s,[r,a])=>{if(a===void 0||a._def===void 0)return s;const i=[...e.currentPath,"properties",r],o=S(a._def,{...e,currentPath:i,propertyPath:i});if(o===void 0)return s;if(e.openaiStrictMode&&a.isOptional()&&!a.isNullable()&&typeof a._def?.defaultValue>"u")throw new Error(`Zod field at \`${i.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...s.properties,[r]:o},required:a.isOptional()&&!e.openaiStrictMode?s.required:[...s.required,r]}},{properties:{},required:[]}),additionalProperties:Ko(t,e)};return n.required.length||delete n.required,n}const zo=(t,e)=>{if(e.propertyPath&&e.currentPath.slice(0,e.propertyPath.length).toString()===e.propertyPath.toString())return S(t.innerType._def,{...e,currentPath:e.currentPath});const n=S(t.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}},Ho=(t,e)=>{if(e.pipeStrategy==="input")return S(t.in._def,e);if(e.pipeStrategy==="output")return S(t.out._def,e);const n=S(t.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),s=S(t.out._def,{...e,currentPath:[...e.currentPath,"allOf",n?"1":"0"]});return{allOf:[n,s].filter(r=>r!==void 0)}};function Vo(t,e){return S(t.type._def,e)}function Xo(t,e){const s={type:"array",uniqueItems:!0,items:S(t.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return t.minSize&&A(s,"minItems",t.minSize.value,t.minSize.message,e),t.maxSize&&A(s,"maxItems",t.maxSize.value,t.maxSize.message,e),s}function Go(t,e){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((n,s)=>S(n._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((n,s)=>s===void 0?n:[...n,s],[]),additionalItems:S(t.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((n,s)=>S(n._def,{...e,currentPath:[...e.currentPath,"items",`${s}`]})).reduce((n,s)=>s===void 0?n:[...n,s],[])}}function Qo(){return{not:{}}}function Yo(){return{}}const eu=(t,e)=>S(t.innerType._def,e);function S(t,e,n=!1){const s=e.seen.get(t);if(e.override){const i=e.override?.(t,e,s,n);if(i!==bo)return i}if(s&&!n){const i=tu(s,e);if(i!==void 0)return"$ref"in i&&e.seenRefs.add(i.$ref),i}const r={def:t,path:e.currentPath,jsonSchema:void 0};e.seen.set(t,r);const a=su(t,t.typeName,e,n);return a&&ru(t,e,a),r.jsonSchema=a,a}const tu=(t,e)=>{switch(e.$refStrategy){case"root":return{$ref:t.path.join("/")};case"extract-to-root":const n=t.path.slice(e.basePath.length+1).join("_");return n!==e.name&&e.nameStrategy==="duplicate-ref"&&(e.definitions[n]=t.def),{$ref:[...e.basePath,e.definitionPath,n].join("/")};case"relative":return{$ref:nu(e.currentPath,t.path)};case"none":case"seen":return t.path.length<e.currentPath.length&&t.path.every((s,r)=>e.currentPath[r]===s)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},nu=(t,e)=>{let n=0;for(;n<t.length&&n<e.length&&t[n]===e[n];n++);return[(t.length-n).toString(),...e.slice(n)].join("/")},su=(t,e,n,s)=>{switch(e){case I.ZodString:return Oa(t,n);case I.ZodNumber:return Jo(t,n);case I.ZodObject:return Zo(t,n);case I.ZodBigInt:return To(t,n);case I.ZodBoolean:return So();case I.ZodDate:return xa(t,n);case I.ZodUndefined:return Qo();case I.ZodNull:return Bo(n);case I.ZodArray:return ko(t,n);case I.ZodUnion:case I.ZodDiscriminatedUnion:return Wo(t,n);case I.ZodIntersection:return No(t,n);case I.ZodTuple:return Go(t,n);case I.ZodRecord:return Ia(t,n);case I.ZodLiteral:return jo(t,n);case I.ZodEnum:return Eo(t);case I.ZodNativeEnum:return Do(t);case I.ZodNullable:return qo(t,n);case I.ZodOptional:return zo(t,n);case I.ZodMap:return Lo(t,n);case I.ZodSet:return Xo(t,n);case I.ZodLazy:return S(t.getter()._def,n);case I.ZodPromise:return Vo(t,n);case I.ZodNaN:case I.ZodNever:return Fo();case I.ZodEffects:return Po(t,n,s);case I.ZodAny:return Io();case I.ZodUnknown:return Yo();case I.ZodDefault:return $o(t,n);case I.ZodBranded:return Co(t,n);case I.ZodReadonly:return eu(t,n);case I.ZodCatch:return Ao(t,n);case I.ZodPipeline:return Ho(t,n);case I.ZodFunction:case I.ZodVoid:case I.ZodSymbol:return;default:return(r=>{})()}},ru=(t,e,n)=>(t.description&&(n.description=t.description,e.markdownDescription&&(n.markdownDescription=t.description)),n),au=(t,e)=>{const n=Oo(e),s=typeof e=="string"?e:e?.nameStrategy==="title"?void 0:e?.name,r=S(t._def,s===void 0?n:{...n,currentPath:[...n.basePath,n.definitionPath,s]},!1)??{},a=typeof e=="object"&&e.name!==void 0&&e.nameStrategy==="title"?e.name:void 0;a!==void 0&&(r.title=a);const i=(()=>{if(xo(n.definitions))return;const l={},u=new Set;for(let m=0;m<500;m++){const p=Object.entries(n.definitions).filter(([f])=>!u.has(f));if(p.length===0)break;for(const[f,d]of p)l[f]=S(fn(d),{...n,currentPath:[...n.basePath,n.definitionPath,f]},!0)??{},u.add(f)}return l})(),o=s===void 0?i?{...r,[n.definitionPath]:i}:r:n.nameStrategy==="duplicate-ref"?{...r,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[s]:r}:void 0}}:void 0}:{$ref:[...n.$refStrategy==="relative"?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...i,[s]:r}};return n.target==="jsonSchema7"?o.$schema="http://json-schema.org/draft-07/schema#":n.target==="jsonSchema2019-09"&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function iu(t){if(t.type!=="object")throw new Error(`Root schema must have type: 'object' but got type: ${t.type?`'${t.type}'`:"undefined"}`);const e=structuredClone(t);return le(e,[],e)}function hn(t){if(typeof t=="boolean")return!1;if(t.type==="null")return!0;for(const e of t.oneOf??[])if(hn(e))return!0;for(const e of t.anyOf??[])if(hn(e))return!0;return!1}function le(t,e,n){if(typeof t=="boolean")throw new TypeError(`Expected object schema but got boolean; path=${e.join("/")}`);if(!he(t))throw new TypeError(`Expected ${JSON.stringify(t)} to be an object; path=${e.join("/")}`);const s=t.$defs;if(he(s))for(const[f,d]of Object.entries(s))le(d,[...e,"$defs",f],n);const r=t.definitions;if(he(r))for(const[f,d]of Object.entries(r))le(d,[...e,"definitions",f],n);t.type==="object"&&!("additionalProperties"in t)&&(t.additionalProperties=!1);const i=t.required??[],o=t.properties;if(he(o)){for(const[f,d]of Object.entries(o))if(!hn(d)&&!i.includes(f))throw new Error(`Zod field at \`${[...e,"properties",f].join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);t.required=Object.keys(o),t.properties=Object.fromEntries(Object.entries(o).map(([f,d])=>[f,le(d,[...e,"properties",f],n)]))}const l=t.items;he(l)&&(t.items=le(l,[...e,"items"],n));const u=t.anyOf;Array.isArray(u)&&(t.anyOf=u.map((f,d)=>le(f,[...e,"anyOf",String(d)],n)));const m=t.allOf;if(Array.isArray(m))if(m.length===1){const f=le(m[0],[...e,"allOf","0"],n);Object.assign(t,f),delete t.allOf}else t.allOf=m.map((f,d)=>le(f,[...e,"allOf",String(d)],n));t.default===null&&delete t.default;const p=t.$ref;if(p&&uu(t,1)){if(typeof p!="string")throw new TypeError(`Received non-string $ref - ${p}; path=${e.join("/")}`);const f=ou(n,p);if(typeof f=="boolean")throw new Error(`Expected \`$ref: ${p}\` to resolve to an object schema but got boolean`);if(!he(f))throw new Error(`Expected \`$ref: ${p}\` to resolve to an object but got ${JSON.stringify(f)}`);return Object.assign(t,{...f,...t}),delete t.$ref,le(t,e,n)}return t}function ou(t,e){if(!e.startsWith("#/"))throw new Error(`Unexpected $ref format ${JSON.stringify(e)}; Does not start with #/`);const n=e.slice(2).split("/");let s=t;for(const r of n){if(!he(s))throw new Error(`encountered non-object entry while resolving ${e} - ${JSON.stringify(s)}`);const a=s[r];if(a===void 0)throw new Error(`Key ${r} not found while resolving ${e}`);s=a}return s}function he(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function uu(t,e){let n=0;for(const s in t)if(n++,n>e)return!0;return!1}function lu(t,e){return au(t,{openaiStrictMode:!0,name:e.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function cu(t){return iu(Ka(t,{target:"draft-7"}))}function du(t){return"_zod"in t}function pu(t,e,n){return $i({type:"json_schema",json_schema:{...n,name:e,strict:!0,schema:du(t)?cu(t):lu(t,{name:e})}},s=>t.parse(JSON.parse(s)))}const Rs=["jsonSchema","functionCalling","jsonMode"];function fu(t,e){if(typeof e<"u"&&!Rs.includes(e))throw new Error(`Invalid method: ${e}. Supported methods are: ${Rs.join(", ")}`);const n=!t.startsWith("gpt-3")&&!t.startsWith("gpt-4-")&&t!=="gpt-4";if(n&&!e)return"jsonSchema";if(!n&&e==="jsonSchema")throw new Error(`JSON Schema is not supported for model "${t}". Please use a different method, e.g. "functionCalling" or "jsonMode".`);return e??"functionCalling"}function hu(t,e){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:e,enumerable:!1}}),n}function mu(t,e,n){if($a(t))return pu(t,e,n);if(Pa(t))return hu({type:"json_schema",json_schema:{...n,name:e,strict:!0,schema:$e(t,{cycles:"ref",reused:"ref",override(s){s.jsonSchema.title=e}})}},s=>Za(t,JSON.parse(s)));throw new Error("Unsupported schema response format")}function gu(t,e){if(e&&typeof e=="object"&&"images"in e&&Array.isArray(e.images)){const n=e.images.filter(s=>typeof s?.image_url?.url=="string").map(s=>({type:"image",url:s.image_url.url}));return[{type:"text",text:t},...n]}return t}const _u={"gpt-4.1-nano":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"text-embedding-3-small":{maxInputTokens:8191,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1536,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-pro":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-05-13":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-08-06":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4.1-mini":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-deep-research":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-3.5-turbo":{maxInputTokens:16385,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!1,imageUrlInputs:!1,pdfToolMessage:!1,imageToolMessage:!1,toolChoice:!0},"text-embedding-3-large":{maxInputTokens:8191,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:3072,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4-turbo":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-preview":{maxInputTokens:128e3,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-mini":{maxInputTokens:2e5,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"codex-mini-latest":{maxInputTokens:2e5,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-nano":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-codex":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4.1":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o4-mini":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},o1:{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-mini":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-mini":{maxInputTokens:128e3,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:65536,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"text-embedding-ada-002":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1536,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-pro":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-11-20":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},o3:{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o4-mini-deep-research":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-chat-latest":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-mini":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-pro":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:272e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0}};var yu=_u,Bn=class extends Ja{temperature;topP;frequencyPenalty;presencePenalty;n;logitBias;model="gpt-3.5-turbo";modelKwargs;stop;stopSequences;user;timeout;streaming=!1;streamUsage=!0;maxTokens;logprobs;topLogprobs;apiKey;organization;__includeRawResponse;client;clientConfig;supportsStrictToolCalling;audio;modalities;reasoning;zdrEnabled;service_tier;promptCacheKey;promptCacheRetention;verbosity;defaultOptions;_llmType(){return"openai"}static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning","service_tier"]}lc_serializable=!0;get lc_secrets(){return{apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{apiKey:"openai_api_key",modelName:"model"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","model","modelName","modelKwargs","stop","stopSequences","timeout","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","zdrEnabled","reasoning","promptCacheKey","promptCacheRetention","verbosity"]}getLsParams(t){const e=this.invocationParams(t);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:e.temperature??void 0,ls_max_tokens:e.max_tokens??void 0,ls_stop:t.stop}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}constructor(t){super(t??{});const e=typeof t?.configuration?.apiKey=="string"||typeof t?.configuration?.apiKey=="function"?t?.configuration?.apiKey:void 0;this.apiKey=t?.apiKey??e??Jn("OPENAI_API_KEY"),this.organization=t?.configuration?.organization??Jn("OPENAI_ORGANIZATION"),this.model=t?.model??t?.modelName??this.model,this.modelKwargs=t?.modelKwargs??{},this.timeout=t?.timeout,this.temperature=t?.temperature??this.temperature,this.topP=t?.topP??this.topP,this.frequencyPenalty=t?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=t?.presencePenalty??this.presencePenalty,this.logprobs=t?.logprobs,this.topLogprobs=t?.topLogprobs,this.n=t?.n??this.n,this.logitBias=t?.logitBias,this.stop=t?.stopSequences??t?.stop,this.stopSequences=this.stop,this.user=t?.user,this.__includeRawResponse=t?.__includeRawResponse,this.audio=t?.audio,this.modalities=t?.modalities,this.reasoning=t?.reasoning,this.maxTokens=t?.maxCompletionTokens??t?.maxTokens,this.promptCacheKey=t?.promptCacheKey??this.promptCacheKey,this.promptCacheRetention=t?.promptCacheRetention??this.promptCacheRetention,this.verbosity=t?.verbosity??this.verbosity,this.disableStreaming=t?.disableStreaming===!0,this.streaming=t?.streaming===!0,this.disableStreaming&&(this.streaming=!1),t?.streaming===!1&&(this.disableStreaming=!0),this.streamUsage=t?.streamUsage??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...t?.configuration},t?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=t.supportsStrictToolCalling),t?.service_tier!==void 0&&(this.service_tier=t.service_tier),this.zdrEnabled=t?.zdrEnabled??!1}_getReasoningParams(t){if(!He(this.model))return;let e;return this.reasoning!==void 0&&(e={...e,...this.reasoning}),t?.reasoning!==void 0&&(e={...e,...t.reasoning}),e}_getResponseFormat(t){return t&&t.type==="json_schema"&&t.json_schema.schema&&Xe(t.json_schema.schema)?mu(t.json_schema.schema,t.json_schema.name,{description:t.json_schema.description}):t}_combineCallOptions(t){return{...this.defaultOptions,...t??{}}}_getClientOptions(t){if(!this.client){const n={baseURL:this.clientConfig.baseURL},s=ro(n),r={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};r.baseURL||delete r.baseURL,r.defaultHeaders=oo(r.defaultHeaders),this.client=new k(r)}return{...this.clientConfig,...t}}_convertChatOpenAIToolToCompletionsTool(t,e){return Tt(t)?wo(t.metadata.customTool):Us(t)?e?.strict!==void 0?{...t,function:{...t.function,strict:e.strict}}:t:uo(t,e)}bindTools(t,e){let n;return e?.strict!==void 0?n=e.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling),this.withConfig({tools:t.map(s=>Fn(s)||Tt(s)?s:po(s)?s.extras.providerToolDefinition:this._convertChatOpenAIToolToCompletionsTool(s,{strict:n})),...e})}async stream(t,e){return super.stream(t,this._combineCallOptions(e))}async invoke(t,e){return super.invoke(t,this._combineCallOptions(e))}_combineLLMOutput(...t){return t.reduce((e,n)=>(n&&n.tokenUsage&&(e.tokenUsage.completionTokens+=n.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=n.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=n.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}async getNumTokensFromMessages(t){let e=0,n=0,s=0;this.model==="gpt-3.5-turbo-0301"?(n=4,s=-1):(n=3,s=1);const r=await Promise.all(t.map(async a=>{const i=await this.getNumTokens(a.content),o=await this.getNumTokens(Ve(a)),l=a.name!==void 0?s+await this.getNumTokens(a.name):0;let u=i+n+o+l;const m=a;if(m._getType()==="function"&&(u-=2),m.additional_kwargs?.function_call&&(u+=3),m?.additional_kwargs.function_call?.name&&(u+=await this.getNumTokens(m.additional_kwargs.function_call?.name)),m.additional_kwargs.function_call?.arguments)try{u+=await this.getNumTokens(JSON.stringify(JSON.parse(m.additional_kwargs.function_call?.arguments)))}catch(p){console.error("Error parsing function arguments",p,JSON.stringify(m.additional_kwargs.function_call)),u+=await this.getNumTokens(m.additional_kwargs.function_call?.arguments)}return e+=u,u}));return e+=3,{totalCount:e,countPerMessage:r}}async _getNumTokensFromGenerations(t){return(await Promise.all(t.map(async n=>n.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([n.message])).countPerMessage[0]:await this.getNumTokens(n.message.content)))).reduce((n,s)=>n+s,0)}async _getEstimatedTokenCountFromPrompt(t,e,n){let s=(await this.getNumTokensFromMessages(t)).totalCount;if(e&&n!=="auto"){const r=co(e);s+=await this.getNumTokens(r),s+=9}return e&&t.find(r=>r._getType()==="system")&&(s-=4),n==="none"?s+=1:typeof n=="object"&&(s+=await this.getNumTokens(n.name)+4),s}async moderateContent(t,e){const n=this._getClientOptions(e?.options),s=e?.model??"omni-moderation-latest",r={input:t,model:s};return this.caller.call(async()=>{try{return await this.client.moderations.create(r,n)}catch(a){throw Dn(a)}})}get profile(){return yu[this.model]??{}}_getStructuredOutputMethod(t){const e={...t};if(!this.model.startsWith("gpt-3")&&!this.model.startsWith("gpt-4-")&&this.model!=="gpt-4"){if(e?.method===void 0)return"jsonSchema"}else e.method==="jsonSchema"&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`);return e.method}withStructuredOutput(t,e){let n,s;const{schema:r,name:a,includeRaw:i}={...e,schema:t};if(e?.strict!==void 0&&e.method==="jsonMode")throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");const o=fu(this.model,e?.method);if(o==="jsonMode"){Xe(r)?s=Hn.fromZodSchema(r):s=new Vn;const p=$e(r);n=this.withConfig({outputVersion:"v0",response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"json_mode"},schema:{title:a??"extract",...p}}})}else if(o==="jsonSchema"){const p={name:a??"extract",description:Ea(r),schema:r,strict:e?.strict},f=$e(p.schema);if(n=this.withConfig({outputVersion:"v0",response_format:{type:"json_schema",json_schema:p},ls_structured_output_format:{kwargs:{method:"json_schema"},schema:{title:p.name,description:p.description,...f}}}),Xe(r)){const d=Hn.fromZodSchema(r);s=Ma.from(b=>"parsed"in b.additional_kwargs?b.additional_kwargs.parsed:d)}else s=new Vn}else{let p=a??"extract";if(Xe(r)){const f=$e(r);n=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:{name:p,description:f.description,parameters:f}}],tool_choice:{type:"function",function:{name:p}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:p,...f}},...e?.strict!==void 0?{strict:e.strict}:{}}),s=new Gn({returnSingle:!0,keyName:p,zodSchema:r})}else{let f;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(f=r,p=r.name):(p=r.title??p,f={name:p,description:r.description??"",parameters:r});const d=$e(r);n=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:f}],tool_choice:{type:"function",function:{name:p}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:p,...d}},...e?.strict!==void 0?{strict:e.strict}:{}}),s=new Gn({returnSingle:!0,keyName:p})}}if(!i)return n.pipe(s);const l=Xn.assign({parsed:(p,f)=>s.invoke(p.raw,f)}),u=Xn.assign({parsed:()=>null}),m=l.withFallbacks({fallbacks:[u]});return Na.from([{raw:n},m])}};const ka={providerName:"ChatOpenAI",fromStandardTextBlock(t){return{type:"text",text:t.text}},fromStandardImageBlock(t){if(t.source_type==="url")return{type:"image_url",image_url:{url:t.url,...t.metadata?.detail?{detail:t.metadata.detail}:{}}};if(t.source_type==="base64")return{type:"image_url",image_url:{url:`data:${t.mime_type??""};base64,${t.data}`,...t.metadata?.detail?{detail:t.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(t){if(t.source_type==="url"){const e=Zn({dataUrl:t.url});if(!e)throw new Error(`URL audio blocks with source_type ${t.source_type} must be formatted as a data URL for ChatOpenAI`);const n=e.mime_type||t.mime_type||"";let s;try{s=zn(n)}catch{throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`)}if(s.type!=="audio"||s.subtype!=="wav"&&s.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:s.subtype,data:e.data}}}if(t.source_type==="base64"){let e;try{e=zn(t.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`)}if(e.type!=="audio"||e.subtype!=="wav"&&e.subtype!=="mp3")throw new Error(`Audio blocks with source_type ${t.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:e.subtype,data:t.data}}}throw new Error(`Audio content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(t){if(t.source_type==="url"){const e=Zn({dataUrl:t.url}),n=It(t);if(!e)throw new Error(`URL file blocks with source_type ${t.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:t.url,...t.metadata?.filename||t.metadata?.name?{filename:n}:{}}}}if(t.source_type==="base64"){const e=It(t);return{type:"file",file:{file_data:`data:${t.mime_type??""};base64,${t.data}`,...t.metadata?.filename||t.metadata?.name||t.metadata?.title?{filename:e}:{}}}}if(t.source_type==="id")return{type:"file",file:{file_id:t.id}};throw new Error(`File content blocks with source_type ${t.source_type} are not supported for ChatOpenAI`)}},wu=({message:t,rawResponse:e,includeRawResponse:n})=>{const s=t.tool_calls;switch(t.role){case"assistant":{const r=[],a=[];for(const u of s??[])try{r.push(Ds(u,{returnId:!0}))}catch(m){a.push(at(u,m.message))}const i={function_call:t.function_call,tool_calls:s};n!==void 0&&(i.__raw_response=e);const o={model_provider:"openai",model_name:e.model,...e.system_fingerprint?{usage:{...e.usage},system_fingerprint:e.system_fingerprint}:{}};t.audio&&(i.audio=t.audio);const l=gu(t.content||"",e.choices?.[0]?.message);return new Se({content:l,tool_calls:r,invalid_tool_calls:a,additional_kwargs:i,response_metadata:o,id:e.id})}default:return new Es(t.content||"",t.role??"unknown")}},bu=({delta:t,rawResponse:e,includeRawResponse:n,defaultRole:s})=>{const r=t.role??s,a=t.content??"";let i;t.function_call?i={function_call:t.function_call}:t.tool_calls?i={tool_calls:t.tool_calls}:i={},n&&(i.__raw_response=e),t.audio&&(i.audio={...t.audio,index:e.choices[0].index});const o={model_provider:"openai",usage:{...e.usage}};if(r==="user")return new ja({content:a,response_metadata:o});if(r==="assistant"){const l=[];if(Array.isArray(t.tool_calls))for(const u of t.tool_calls)l.push({name:u.function?.name,args:u.function?.arguments,id:u.id,index:u.index,type:"tool_call_chunk"});return new mn({content:a,tool_call_chunks:l,additional_kwargs:i,id:e.id,response_metadata:o})}else return r==="system"?new Kn({content:a,response_metadata:o}):r==="developer"?new Kn({content:a,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):r==="function"?new Ua({content:a,additional_kwargs:i,name:t.name,response_metadata:o}):r==="tool"?new La({content:a,additional_kwargs:i,tool_call_id:t.tool_call_id,response_metadata:o}):new Da({content:a,role:r,response_metadata:o})},vu=t=>{if(t.type==="image"){if(t.url)return{type:"image_url",image_url:{url:t.url}};if(t.data)return{type:"image_url",image_url:{url:`data:${t.mimeType};base64,${t.data}`}}}if(t.type==="audio"&&t.data){const e=Fa(()=>{const[,n]=t.mimeType.split("/");return n==="wav"||n==="mp3"?n:"wav"});return{type:"input_audio",input_audio:{data:t.data.toString(),format:e}}}if(t.type==="file"){if(t.data){const e=It(t);return{type:"file",file:{file_data:`data:${t.mimeType};base64,${t.data}`,filename:e}}}if(t.fileId)return{type:"file",file:{file_id:t.fileId}}}},xu=({message:t,model:e})=>{let n=Ve(t);if(n==="system"&&He(e)&&(n="developer"),n==="developer")return{role:"developer",content:t.contentBlocks.filter(r=>r.type==="text")};if(n==="system")return{role:"system",content:t.contentBlocks.filter(r=>r.type==="text")};if(n==="assistant")return{role:"assistant",content:t.contentBlocks.filter(r=>r.type==="text")};if(n==="tool"&&js.isInstance(t))return{role:"tool",tool_call_id:t.tool_call_id,content:t.contentBlocks.filter(r=>r.type==="text")};if(n==="function")return{role:"function",name:t.name??"",content:t.contentBlocks.filter(r=>r.type==="text").join("")};function*s(r){for(const a of r){a.type==="text"&&(yield{type:"text",text:a.text});const i=vu(a);i&&(yield i)}}return{role:"user",content:Array.from(s(t.contentBlocks))}},$s=({messages:t,model:e})=>t.flatMap(n=>{if("output_version"in n.response_metadata&&n.response_metadata?.output_version==="v1")return xu({message:n});let s=Ve(n);s==="system"&&He(e)&&(s="developer");const r=typeof n.content=="string"?n.content:n.content.map(i=>Ms(i)?Ns(i,ka):i),a={role:s,content:r};if(n.name!=null&&(a.name=n.name),n.additional_kwargs.function_call!=null&&(a.function_call=n.additional_kwargs.function_call),Se.isInstance(n)&&n.tool_calls?.length?a.tool_calls=n.tool_calls.map(Ha):(n.additional_kwargs.tool_calls!=null&&(a.tool_calls=n.additional_kwargs.tool_calls),js.isInstance(n)&&n.tool_call_id!=null&&(a.tool_call_id=n.tool_call_id)),n.additional_kwargs.audio&&typeof n.additional_kwargs.audio=="object"&&"id"in n.additional_kwargs.audio){const i={role:"assistant",audio:{id:n.additional_kwargs.audio.id}};return[a,i]}return a});var Ou=class extends Bn{invocationParams(t,e){let n;t?.strict!==void 0?n=t.strict:this.supportsStrictToolCalling!==void 0&&(n=this.supportsStrictToolCalling);let s={};t?.stream_options!==void 0?s={stream_options:t.stream_options}:this.streamUsage&&(this.streaming||e?.streaming)&&(s={stream_options:{include_usage:!0}});const r={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:t?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:t?.functions,function_call:t?.function_call,tools:t?.tools?.length?t.tools.map(i=>this._convertChatOpenAIToolToCompletionsTool(i,{strict:n})):void 0,tool_choice:wa(t?.tool_choice),response_format:this._getResponseFormat(t?.response_format),seed:t?.seed,...s,parallel_tool_calls:t?.parallel_tool_calls,...this.audio||t?.audio?{audio:this.audio||t?.audio}:{},...this.modalities||t?.modalities?{modalities:this.modalities||t?.modalities}:{},...this.modelKwargs,prompt_cache_key:t?.promptCacheKey??this.promptCacheKey,prompt_cache_retention:t?.promptCacheRetention??this.promptCacheRetention,verbosity:t?.verbosity??this.verbosity};t?.prediction!==void 0&&(r.prediction=t.prediction),this.service_tier!==void 0&&(r.service_tier=this.service_tier),t?.service_tier!==void 0&&(r.service_tier=t.service_tier);const a=this._getReasoningParams(t);return a!==void 0&&a.effort!==void 0&&(r.reasoning_effort=a.effort),He(r.model)?r.max_completion_tokens=this.maxTokens===-1?void 0:this.maxTokens:r.max_tokens=this.maxTokens===-1?void 0:this.maxTokens,r}async _generate(t,e,n){const s={},r=this.invocationParams(e),a=$s({messages:t,model:this.model});if(r.stream){const i=this._streamResponseChunks(t,e,n),o={};for await(const d of i){d.message.response_metadata={...d.generationInfo,...d.message.response_metadata};const b=d.generationInfo?.completion??0;o[b]===void 0?o[b]=d:o[b]=o[b].concat(d)}const l=Object.entries(o).sort(([d],[b])=>parseInt(d,10)-parseInt(b,10)).map(([d,b])=>b),{functions:u,function_call:m}=this.invocationParams(e),p=await this._getEstimatedTokenCountFromPrompt(t,u,m),f=await this._getNumTokensFromGenerations(l);return s.input_tokens=p,s.output_tokens=f,s.total_tokens=p+f,{generations:l,llmOutput:{estimatedTokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}else{const i=await this.completionWithRetry({...r,stream:!1,messages:a},{signal:e?.signal,...e?.options}),{completion_tokens:o,prompt_tokens:l,total_tokens:u,prompt_tokens_details:m,completion_tokens_details:p}=i?.usage??{};o&&(s.output_tokens=(s.output_tokens??0)+o),l&&(s.input_tokens=(s.input_tokens??0)+l),u&&(s.total_tokens=(s.total_tokens??0)+u),(m?.audio_tokens!==null||m?.cached_tokens!==null)&&(s.input_token_details={...m?.audio_tokens!==null&&{audio:m?.audio_tokens},...m?.cached_tokens!==null&&{cache_read:m?.cached_tokens}}),(p?.audio_tokens!==null||p?.reasoning_tokens!==null)&&(s.output_token_details={...p?.audio_tokens!==null&&{audio:p?.audio_tokens},...p?.reasoning_tokens!==null&&{reasoning:p?.reasoning_tokens}});const f=[];for(const d of i?.choices??[]){const w={text:d.message?.content??"",message:this._convertCompletionsMessageToBaseMessage(d.message??{role:"assistant"},i)};w.generationInfo={...d.finish_reason?{finish_reason:d.finish_reason}:{},...d.logprobs?{logprobs:d.logprobs}:{}},Ba(w.message)&&(w.message.usage_metadata=s),w.message=new Se(Object.fromEntries(Object.entries(w.message).filter(([$])=>!$.startsWith("lc_")))),f.push(w)}return{generations:f,llmOutput:{tokenUsage:{promptTokens:s.input_tokens,completionTokens:s.output_tokens,totalTokens:s.total_tokens}}}}}async*_streamResponseChunks(t,e,n){const s=$s({messages:t,model:this.model}),r={...this.invocationParams(e,{streaming:!0}),messages:s,stream:!0};let a;const i=await this.completionWithRetry(r,e);let o;for await(const l of i){const u=l?.choices?.[0];if(l.usage&&(o=l.usage),!u)continue;const{delta:m}=u;if(!m)continue;const p=this._convertCompletionsDeltaToBaseMessageChunk(m,l,a);a=m.role??a;const f={prompt:e.promptIndex??0,completion:u.index??0};if(typeof p.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const d={...f};u.finish_reason!=null&&(d.finish_reason=u.finish_reason,d.system_fingerprint=l.system_fingerprint,d.model_name=l.model,d.service_tier=l.service_tier),this.logprobs&&(d.logprobs=u.logprobs);const b=new Gt({message:p,text:p.content,generationInfo:d});yield b,await n?.handleLLMNewToken(b.text??"",f,void 0,void 0,void 0,{chunk:b})}if(o){const l={...o.prompt_tokens_details?.audio_tokens!==null&&{audio:o.prompt_tokens_details?.audio_tokens},...o.prompt_tokens_details?.cached_tokens!==null&&{cache_read:o.prompt_tokens_details?.cached_tokens}},u={...o.completion_tokens_details?.audio_tokens!==null&&{audio:o.completion_tokens_details?.audio_tokens},...o.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:o.completion_tokens_details?.reasoning_tokens}};yield new Gt({message:new mn({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(l).length>0&&{input_token_details:l},...Object.keys(u).length>0&&{output_token_details:u}}}),text:""})}if(e.signal?.aborted)throw new Error("AbortError")}async completionWithRetry(t,e){const n=this._getClientOptions(e),s=t.response_format&&t.response_format.type==="json_schema";return this.caller.call(async()=>{try{return s&&!t.stream?await this.client.chat.completions.parse(t,n):await this.client.chat.completions.create(t,n)}catch(r){throw Dn(r)}})}_convertCompletionsDeltaToBaseMessageChunk(t,e,n){return bu({delta:t,rawResponse:e,includeRawResponse:this.__includeRawResponse,defaultRole:n})}_convertCompletionsMessageToBaseMessage(t,e){return wu({message:t,rawResponse:e,includeRawResponse:this.__includeRawResponse})}};const Ct="__openai_function_call_ids__",Ta=t=>{const e={...t?.input_tokens_details?.cached_tokens!=null&&{cache_read:t?.input_tokens_details?.cached_tokens}},n={...t?.output_tokens_details?.reasoning_tokens!=null&&{reasoning:t?.output_tokens_details?.reasoning_tokens}};return{input_tokens:t?.input_tokens??0,output_tokens:t?.output_tokens??0,total_tokens:t?.total_tokens??0,input_token_details:e,output_token_details:n}},Sa=t=>{if(t.error){const o=new Error(t.error.message);throw o.name=t.error.code,o}let e;const n=[],s=[],r=[],a={model_provider:"openai",model:t.model,created_at:t.created_at,id:t.id,incomplete_details:t.incomplete_details,metadata:t.metadata,object:t.object,status:t.status,user:t.user,service_tier:t.service_tier,model_name:t.model},i={};for(const o of t.output)if(o.type==="message")e=o.id,n.push(...o.content.flatMap(l=>l.type==="output_text"?("parsed"in l&&l.parsed!=null&&(i.parsed=l.parsed),{type:"text",text:l.text,annotations:l.annotations}):l.type==="refusal"?(i.refusal=l.refusal,[]):l));else if(o.type==="function_call"){const l={function:{name:o.name,arguments:o.arguments},id:o.call_id};try{s.push(Ds(l,{returnId:!0}))}catch(u){let m;typeof u=="object"&&u!=null&&"message"in u&&typeof u.message=="string"&&(m=u.message),r.push(at(l,m))}i[Ct]??={},o.id&&(i[Ct][o.call_id]=o.id)}else if(o.type==="reasoning")i.reasoning=o;else if(o.type==="custom_tool_call"){const l=ho(o);l?s.push(l):r.push(at(o,"Malformed custom tool call"))}else if(o.type==="computer_call"){const l=mo(o);l?s.push(l):r.push(at(o,"Malformed computer call"))}else i.tool_outputs??=[],i.tool_outputs.push(o);return new Se({id:e,content:n,tool_calls:s,invalid_tool_calls:r,usage_metadata:Ta(t.usage),additional_kwargs:i,response_metadata:a})},Iu=t=>{const e=(t.summary.length>1?t.summary.reduce((n,s)=>{const r=n[n.length-1];return r.index===s.index?r.text+=s.text:n.push(s),n},[{...t.summary[0]}]):t.summary).map(n=>Object.fromEntries(Object.entries(n).filter(([s])=>s!=="index")));return{...t,summary:e}},ku=t=>{const e=[];let n={},s;const r=[],a={model_provider:"openai"},i={};let o;if(t.type==="response.output_text.delta")e.push({type:"text",text:t.delta,index:t.content_index});else if(t.type==="response.output_text.annotation.added")e.push({type:"text",text:"",annotations:[t.annotation],index:t.content_index});else if(t.type==="response.output_item.added"&&t.item.type==="message")o=t.item.id;else if(t.type==="response.output_item.added"&&t.item.type==="function_call")r.push({type:"tool_call_chunk",name:t.item.name,args:t.item.arguments,id:t.item.call_id,index:t.output_index}),i[Ct]={[t.item.call_id]:t.item.id};else if(t.type==="response.output_item.done"&&t.item.type==="computer_call")r.push({type:"tool_call_chunk",name:"computer_use",args:JSON.stringify({action:t.item.action}),id:t.item.call_id,index:t.output_index}),i.tool_outputs=[t.item];else if(t.type==="response.output_item.done"&&["web_search_call","file_search_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call","custom_tool_call"].includes(t.item.type))i.tool_outputs=[t.item];else if(t.type==="response.created")a.id=t.response.id,a.model_name=t.response.model,a.model=t.response.model;else if(t.type==="response.completed"){const l=Sa(t.response);s=Ta(t.response.usage),t.response.text?.format?.type==="json_schema"&&(i.parsed??=JSON.parse(l.text));for(const[u,m]of Object.entries(t.response))u!=="id"&&(a[u]=m)}else if(t.type==="response.function_call_arguments.delta"||t.type==="response.custom_tool_call_input.delta")r.push({type:"tool_call_chunk",args:t.delta,index:t.output_index});else if(t.type==="response.web_search_call.completed"||t.type==="response.file_search_call.completed")n={tool_outputs:{id:t.item_id,type:t.type.replace("response.","").replace(".completed",""),status:"completed"}};else if(t.type==="response.refusal.done")i.refusal=t.refusal;else if(t.type==="response.output_item.added"&&"item"in t&&t.item.type==="reasoning"){const l=t.item.summary?t.item.summary.map((u,m)=>({...u,index:m})):void 0;i.reasoning={id:t.item.id,type:t.item.type,...l?{summary:l}:{}}}else if(t.type==="response.reasoning_summary_part.added")i.reasoning={type:"reasoning",summary:[{...t.part,index:t.summary_index}]};else if(t.type==="response.reasoning_summary_text.delta")i.reasoning={type:"reasoning",summary:[{text:t.delta,type:"summary_text",index:t.summary_index}]};else return t.type==="response.image_generation_call.partial_image",null;return new Gt({text:e.map(l=>l.text).join(""),message:new mn({id:o,content:e,tool_call_chunks:r,usage_metadata:s,additional_kwargs:i,response_metadata:a}),generationInfo:n})},Tu=t=>{const e=Se.isInstance(t)&&t.response_metadata?.model_provider==="openai";function*n(){const s=ye(()=>{try{const h=Ve(t);return h==="system"||h==="developer"||h==="assistant"||h==="user"?h:"assistant"}catch{return"assistant"}});let r;const a=new Set,i=new Set,o=new Map,l=new Map;function*u(){if(!r)return;const h=r.content;(typeof h=="string"&&h.length>0||Array.isArray(h)&&h.length>0)&&(yield r),r=void 0}const m=h=>{r||(r={type:"message",role:s,content:[]}),typeof r.content=="string"?r.content=r.content.length>0?[{type:"input_text",text:r.content},...h]:[...h]:r.content.push(...h)},p=h=>{if(typeof h=="string")return h;try{return JSON.stringify(h??{})}catch{return"{}"}},f=h=>{const g=ye(()=>{const T=h.metadata?.detail;return T==="low"||T==="high"||T==="auto"?T:"auto"});if(h.fileId)return{type:"input_image",detail:g,file_id:h.fileId};if(h.url)return{type:"input_image",detail:g,image_url:h.url};if(h.data){const T=typeof h.data=="string"?h.data:Buffer.from(h.data).toString("base64"),C=h.mimeType??"image/png";return{type:"input_image",detail:g,image_url:`data:${C};base64,${T}`}}},d=h=>{const g=It(h);if(h.fileId&&typeof g=="string")return{type:"input_file",file_id:h.fileId,...g?{filename:g}:{}};if(h.url&&typeof g=="string")return{type:"input_file",file_url:h.url,...g?{filename:g}:{}};if(h.data&&typeof g=="string"){const T=typeof h.data=="string"?h.data:Buffer.from(h.data).toString("base64");return{type:"input_file",file_data:`data:${h.mimeType??"application/octet-stream"};base64,${T}`,...g?{filename:g}:{}}}},b=h=>{const g=ye(()=>{if(Array.isArray(h.summary)){const U=h.summary?.map(R=>R?.text).filter(R=>typeof R=="string")??[];if(U.length>0)return U}return h.reasoning?[h.reasoning]:[]}),T=g.length>0?g.map(Z=>({type:"summary_text",text:Z})):[{type:"summary_text",text:""}],C={type:"reasoning",id:h.id??"",summary:T};return h.reasoning&&(C.content=[{type:"reasoning_text",text:h.reasoning}]),C},w=h=>({type:"function_call",name:h.name??"",call_id:h.id??"",arguments:p(h.args)}),$=h=>{const g=p(h.output),T=h.status==="success"?"completed":h.status==="error"?"incomplete":void 0;return{type:"function_call_output",call_id:h.toolCallId??"",output:g,...T?{status:T}:{}}};for(const h of t.contentBlocks)if(h.type==="text")m([{type:"input_text",text:h.text}]);else if(h.type!=="invalid_tool_call"){if(h.type==="reasoning")yield*u(),yield b(h);else if(h.type==="tool_call"){yield*u();const g=h.id??"";g&&(a.add(g),o.delete(g)),yield w(h)}else if(h.type==="tool_call_chunk"){if(h.id){const g=o.get(h.id)??{name:h.name,args:[]};h.name&&(g.name=h.name),h.args&&g.args.push(h.args),o.set(h.id,g)}}else if(h.type==="server_tool_call"){yield*u();const g=h.id??"";g&&(i.add(g),l.delete(g)),yield w(h)}else if(h.type==="server_tool_call_chunk"){if(h.id){const g=l.get(h.id)??{name:h.name,args:[]};h.name&&(g.name=h.name),h.args&&g.args.push(h.args),l.set(h.id,g)}}else if(h.type==="server_tool_call_result")yield*u(),yield $(h);else if(h.type!=="audio")if(h.type==="file"){const g=d(h);g&&m([g])}else if(h.type==="image"){const g=f(h);g&&m([g])}else if(h.type==="video"){const g=d(h);g&&m([g])}else h.type==="text-plain"?h.text&&m([{type:"input_text",text:h.text}]):h.type==="non_standard"&&e&&(yield*u(),yield h.value)}yield*u();for(const[h,g]of o){if(!h||a.has(h))continue;const T=g.args.join("");!g.name&&!T||(yield{type:"function_call",call_id:h,name:g.name??"",arguments:T})}for(const[h,g]of l){if(!h||i.has(h))continue;const T=g.args.join("");!g.name&&!T||(yield{type:"function_call",call_id:h,name:g.name??"",arguments:T})}}return Array.from(n())},Ps=({messages:t,zdrEnabled:e,model:n})=>t.flatMap(s=>{const r=s.response_metadata;if(r?.output_version==="v1")return Tu(s);const a=s.additional_kwargs;let i=Ve(s);if(i==="system"&&He(n)&&(i="developer"),i==="function")throw new Error("Function messages are not supported in Responses API");if(i==="tool"){const o=s;return a?.type==="computer_call_output"?{type:"computer_call_output",output:(()=>{if(typeof o.content=="string")return{type:"input_image",image_url:o.content};if(Array.isArray(o.content)){const u=o.content.find(f=>f.type==="input_image");if(u)return u;const m=o.content.find(f=>f.type==="computer_screenshot");if(m)return m;const p=o.content.find(f=>f.type==="image_url");if(p)return{type:"input_image",image_url:typeof p.image_url=="string"?p.image_url:p.image_url.url}}throw new Error("Invalid computer call output")})(),call_id:o.tool_call_id}:o.additional_kwargs?.customTool?{type:"custom_tool_call_output",call_id:o.tool_call_id,output:o.content}:{type:"function_call_output",call_id:o.tool_call_id,id:o.id?.startsWith("fc_")?o.id:void 0,output:typeof o.content!="string"?JSON.stringify(o.content):o.content}}if(i==="assistant"){if(!e&&r?.output!=null&&Array.isArray(r?.output)&&r?.output.length>0&&r?.output.every(f=>"type"in f))return r?.output;const o=[];if(a?.reasoning&&!e){const f=Iu(a.reasoning);o.push(f)}let{content:l}=s;a?.refusal&&(typeof l=="string"&&(l=[{type:"output_text",text:l,annotations:[]}]),l=[...l,{type:"refusal",refusal:a.refusal}]),(typeof l=="string"||l.length>0)&&o.push({type:"message",role:"assistant",...s.id&&!e&&s.id.startsWith("msg_")?{id:s.id}:{},content:ye(()=>typeof l=="string"?l:l.flatMap(f=>f.type==="text"?{type:"output_text",text:f.text,annotations:f.annotations??[]}:f.type==="output_text"||f.type==="refusal"?f:[]))});const u=a?.[Ct];Se.isInstance(s)&&s.tool_calls?.length?o.push(...s.tool_calls.map(f=>_o(f)?{type:"custom_tool_call",id:f.call_id,call_id:f.id??"",input:f.args.input,name:f.name}:go(f)?{type:"computer_call",id:f.call_id,call_id:f.id??"",action:f.args.action}:{type:"function_call",name:f.name,arguments:JSON.stringify(f.args),call_id:f.id,...e?{}:{id:u?.[f.id]}})):a?.tool_calls&&o.push(...a.tool_calls.map(f=>({type:"function_call",name:f.function.name,call_id:f.id,arguments:f.function.arguments,...e?{}:{id:u?.[f.id]}})));const m=r?.output?.length?r?.output:a.tool_outputs,p=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(m!=null){const d=m?.filter(b=>p.includes(b.type));d.length>0&&o.push(...d)}return o}if(i==="user"||i==="system"||i==="developer"){if(typeof s.content=="string")return{type:"message",role:i,content:s.content};const o=[],l=s.content.flatMap(u=>{if(u.type==="mcp_approval_response"&&o.push({type:"mcp_approval_response",approval_request_id:u.approval_request_id,approve:u.approve}),Ms(u))return Ns(u,ka);if(u.type==="text")return{type:"input_text",text:u.text};if(u.type==="image_url"){const m=ye(()=>{if(typeof u.image_url=="string")return u.image_url;if(typeof u.image_url=="object"&&u.image_url!==null&&"url"in u.image_url)return u.image_url.url}),p=ye(()=>{if(typeof u.image_url=="string")return"auto";if(typeof u.image_url=="object"&&u.image_url!==null&&"detail"in u.image_url)return u.image_url.detail});return{type:"input_image",image_url:m,detail:p}}return u.type==="input_text"||u.type==="input_image"||u.type==="input_file"?u:[]});return l.length>0&&o.push({type:"message",role:i,content:l}),o}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${i}`),[]});var Su=class extends Bn{invocationParams(t){let e;t?.strict!==void 0&&(e=t.strict),e===void 0&&this.supportsStrictToolCalling!==void 0&&(e=this.supportsStrictToolCalling);const n={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:t?.previous_response_id,truncation:t?.truncation,include:t?.include,tools:t?.tools?.length?this._reduceChatOpenAITools(t.tools,{stream:this.streaming,strict:e}):void 0,tool_choice:fo(t?.tool_choice)?t?.tool_choice:(()=>{const r=wa(t?.tool_choice);if(typeof r=="object"&&"type"in r){if(r.type==="function")return{type:"function",name:r.function.name};if(r.type==="allowed_tools")return{type:"allowed_tools",mode:r.allowed_tools.mode,tools:r.allowed_tools.tools};if(r.type==="custom")return{type:"custom",name:r.custom.name}}})(),text:(()=>{if(t?.text)return t.text;const r=this._getResponseFormat(t?.response_format);return r?.type==="json_schema"?r.json_schema.schema!=null?{format:{type:"json_schema",schema:r.json_schema.schema,description:r.json_schema.description,name:r.json_schema.name,strict:r.json_schema.strict},verbosity:t?.verbosity}:void 0:{format:r,verbosity:t?.verbosity}})(),parallel_tool_calls:t?.parallel_tool_calls,max_output_tokens:this.maxTokens===-1?void 0:this.maxTokens,prompt_cache_key:t?.promptCacheKey??this.promptCacheKey,prompt_cache_retention:t?.promptCacheRetention??this.promptCacheRetention,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},s=this._getReasoningParams(t);return s!==void 0&&(n.reasoning=s),n}async _generate(t,e){const n=this.invocationParams(e);if(n.stream){const s=this._streamResponseChunks(t,e);let r;for await(const a of s)a.message.response_metadata={...a.generationInfo,...a.message.response_metadata},r=r?.concat(a)??a;return{generations:r?[r]:[],llmOutput:{estimatedTokenUsage:r?.message?.usage_metadata}}}else{const s=await this.completionWithRetry({input:Ps({messages:t,zdrEnabled:this.zdrEnabled??!1,model:this.model}),...n,stream:!1},{signal:e?.signal,...e?.options});return{generations:[{text:s.output_text,message:Sa(s)}],llmOutput:{id:s.id,estimatedTokenUsage:s.usage?{promptTokens:s.usage.input_tokens,completionTokens:s.usage.output_tokens,totalTokens:s.usage.total_tokens}:void 0}}}}async*_streamResponseChunks(t,e,n){const s=await this.completionWithRetry({...this.invocationParams(e),input:Ps({messages:t,zdrEnabled:this.zdrEnabled??!1,model:this.model}),stream:!0},e);for await(const r of s){const a=ku(r);a!=null&&(yield a,await n?.handleLLMNewToken(a.text||"",{prompt:e.promptIndex??0,completion:0},void 0,void 0,void 0,{chunk:a}))}}async completionWithRetry(t,e){return this.caller.call(async()=>{const n=this._getClientOptions(e);try{return t.text?.format?.type==="json_schema"&&!t.stream?await this.client.responses.parse(t,n):await this.client.responses.create(t,n)}catch(s){throw Dn(s)}})}_reduceChatOpenAITools(t,e){const n=[];for(const s of t)if(Fn(s))s.type==="image_generation"&&e?.stream&&(s.partial_images=1),n.push(s);else if(Tt(s)){const r=s.metadata.customTool;n.push({type:"custom",name:r.name,description:r.description,format:r.format})}else Us(s)?n.push({type:"function",name:s.function.name,parameters:s.function.parameters,description:s.function.description,strict:e?.strict??null}):ba(s)&&n.push(yo(s));return n}},al=class Ca extends Bn{useResponsesApi=!1;responses;completions;get lc_serializable_keys(){return[...super.lc_serializable_keys,"useResponsesApi"]}get callKeys(){return[...super.callKeys,"useResponsesApi"]}constructor(e){super(e),this.fields=e,this.useResponsesApi=e?.useResponsesApi??!1,this.responses=e?.responses??new Su(e),this.completions=e?.completions??new Ou(e)}_useResponsesApi(e){const n=e?.tools?.some(Fn),s=e?.previous_response_id!=null||e?.text!=null||e?.truncation!=null||e?.include!=null||e?.reasoning?.summary!=null||this.reasoning?.summary!=null,r=e?.tools?.some(ba)||e?.tools?.some(Tt);return this.useResponsesApi||n||s||r||so(this.model)}getLsParams(e){const n=this._combineCallOptions(e);return this._useResponsesApi(e)?this.responses.getLsParams(n):this.completions.getLsParams(n)}invocationParams(e){const n=this._combineCallOptions(e);return this._useResponsesApi(e)?this.responses.invocationParams(n):this.completions.invocationParams(n)}async _generate(e,n,s){return this._useResponsesApi(n)?this.responses._generate(e,n):this.completions._generate(e,n,s)}async*_streamResponseChunks(e,n,s){if(this._useResponsesApi(n)){yield*this.responses._streamResponseChunks(e,this._combineCallOptions(n),s);return}yield*this.completions._streamResponseChunks(e,this._combineCallOptions(n),s)}withConfig(e){const n=new Ca(this.fields);return n.defaultOptions={...this.defaultOptions,...e},n}};const Cu=K({type:ee("screenshot")}),Au=K({type:ee("click"),x:J(),y:J(),button:Ls(["left","right","wheel","back","forward"]).default("left")}),Ru=K({type:ee("double_click"),x:J(),y:J(),button:Ls(["left","right","wheel","back","forward"]).default("left")}),$u=K({type:ee("drag"),path:At(K({x:J(),y:J()}))}),Pu=K({type:ee("keypress"),keys:At(Q())}),Eu=K({type:ee("move"),x:J(),y:J()}),Mu=K({type:ee("scroll"),x:J(),y:J(),scroll_x:J(),scroll_y:J()}),Nu=K({type:ee("type"),text:Q()}),ju=K({type:ee("wait"),duration:J().optional()}),Uu=gn("type",[Cu,Au,Ru,$u,Pu,Eu,Mu,Nu,ju]);K({action:Uu});const Lu=K({type:ee("exec"),command:At(Q()),env:za(Q(),Q()).optional(),working_directory:Q().optional(),timeout_ms:J().optional(),user:Q().optional()});gn("type",[Lu]);K({commands:At(Q()).describe("Array of shell commands to execute"),timeout_ms:J().optional().describe("Optional timeout in milliseconds for the commands"),max_output_length:J().optional().describe("Optional maximum number of characters to return from each command")});const Du=K({type:ee("create_file"),path:Q(),diff:Q()}),Fu=K({type:ee("update_file"),path:Q(),diff:Q()}),Bu=K({type:ee("delete_file"),path:Q()});gn("type",[Du,Fu,Bu]);export{Bn as BaseChatOpenAI,al as ChatOpenAI,Ou as ChatOpenAICompletions,Su as ChatOpenAIResponses,k as OpenAIClient,ka as completionsApiContentBlockConverter,bu as convertCompletionsDeltaToBaseMessageChunk,wu as convertCompletionsMessageToBaseMessage,$s as convertMessagesToCompletionsMessageParams,Ps as convertMessagesToResponsesInput,Iu as convertReasoningSummaryToResponsesReasoningItem,ku as convertResponsesDeltaToChatGenerationChunk,Sa as convertResponsesMessageToAIMessage,Ta as convertResponsesUsageToUsageMetadata,vu as convertStandardContentBlockToCompletionsContentPart,xu as convertStandardContentMessageToCompletionsMessage,Tu as convertStandardContentMessageToResponsesInput,ro as getEndpoint,io as getFormattedEnv,oo as getHeadersWithUserAgent,Ts as isHeaders,Ve as messageToOpenAIRole,ao as normalizeHeaders,Ci as toFile,Dn as wrapOpenAIClientError};
