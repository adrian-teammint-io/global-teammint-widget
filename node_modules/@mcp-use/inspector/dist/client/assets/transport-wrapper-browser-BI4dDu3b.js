class h{listeners=new Map;on(e,s){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(s)}off(e,s){this.listeners.get(e)?.delete(s)}emit(e,...s){this.listeners.get(e)?.forEach(o=>{try{o(...s)}catch(r){console.error("Error in event listener:",r)}})}}class u{emitter=new h;bufferByServer=new Map;publish(e){const s=this.bufferByServer.get(e.serverId)??[];s.push(e),s.length>1e3&&s.shift(),this.bufferByServer.set(e.serverId,s),this.emitter.emit("event",e)}subscribe(e,s){const o=new Set(e),r=t=>{(o.size===0||o.has(t.serverId))&&s(t)};return this.emitter.on("event",r),()=>this.emitter.off("event",r)}getBuffer(e,s){const o=new Set(e),r=[];for(const[t,i]of this.bufferByServer.entries())o.size>0&&!o.has(t)||r.push(...i);return r.sort((t,i)=>i.timestamp.localeCompare(t.timestamp)),s===0?[]:!Number.isFinite(s)||s<0?r:r.slice(0,s)}clear(e){if(e&&e.length>0){const s=new Set(e);for(const o of s)this.bufferByServer.delete(o)}else this.bufferByServer.clear()}}const c=new u,l={publish:async n=>{console.log("[RPC Log Bus Browser] Publishing event:",{serverId:n.serverId,direction:n.direction,method:n.message?.method||"unknown"});try{c.publish(n),console.log("[RPC Log Bus Browser] Published to local bus")}catch(e){console.error("[RPC Log Bus Browser] Failed to publish to local bus:",e)}try{console.log("[RPC Log Bus Browser] Sending to server...");const e=await fetch("/inspector/api/rpc/log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});e.ok?console.log("[RPC Log Bus Browser] Sent to server successfully"):console.warn("[RPC Log Bus Browser] Server returned non-OK status:",e.status)}catch(e){console.warn("[RPC Log Bus Browser] Failed to send event to server:",e)}},subscribe:c.subscribe.bind(c),getBuffer:c.getBuffer.bind(c),clear:c.clear.bind(c)};function f(n,e){console.log("[RPC Logger] Wrapping transport for server:",e);class s{constructor(r){this.inner=r,this.inner.onmessage=(t,i)=>{l.publish({serverId:e,direction:"receive",timestamp:new Date().toISOString(),message:t}).catch(a=>{console.warn("[RPC Logger] Failed to publish receive event:",a)}),this.onmessage?.(t,i)},this.inner.onclose=()=>{this.onclose?.()},this.inner.onerror=t=>{this.onerror?.(t)}}onclose;onerror;onmessage;async start(){typeof this.inner.start=="function"&&await this.inner.start()}async send(r,t){l.publish({serverId:e,direction:"send",timestamp:new Date().toISOString(),message:r}).catch(i=>{console.warn("[RPC Logger] Failed to publish send event:",i)}),await this.inner.send(r,t)}async close(){await this.inner.close()}get sessionId(){return this.inner.sessionId}setProtocolVersion(r){typeof this.inner.setProtocolVersion=="function"&&this.inner.setProtocolVersion(r)}}return new s(n)}export{f as wrapTransportForLogging};
